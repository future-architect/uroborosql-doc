<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>SqlAgentFactory | uroboroSQL</title>
    <meta name="description" content="uroboroSQLはJava製のシンプルなSQL実行ライブラリです">
    <link rel="icon" href="/uroborosql-doc/favicon.ico">
  <meta name="og:type" content="website">
  <meta name="og:description" content="uroboroSQLDeveloper-oriented and SQL centric database access library.">
  <meta name="og:image" content="https://future-architect.github.io/uroborosql-doc/images/logo.png">
    <meta name="og:title" content="SqlAgentFactory"><meta name="og:url" content="/uroborosql-doc/configuration/sql-agent-factory.html">
    <link rel="preload" href="/uroborosql-doc/assets/css/0.styles.951fff52.css" as="style"><link rel="preload" href="/uroborosql-doc/assets/js/app.92bd86c5.js" as="script"><link rel="preload" href="/uroborosql-doc/assets/js/2.8444be12.js" as="script"><link rel="preload" href="/uroborosql-doc/assets/js/21.aeb25471.js" as="script"><link rel="preload" href="/uroborosql-doc/assets/js/4.e334faa4.js" as="script"><link rel="prefetch" href="/uroborosql-doc/assets/js/10.efa4b1ea.js"><link rel="prefetch" href="/uroborosql-doc/assets/js/11.73299a69.js"><link rel="prefetch" href="/uroborosql-doc/assets/js/12.82e9ab28.js"><link rel="prefetch" href="/uroborosql-doc/assets/js/13.0ab03647.js"><link rel="prefetch" href="/uroborosql-doc/assets/js/14.b046f877.js"><link rel="prefetch" href="/uroborosql-doc/assets/js/15.d1aeaa57.js"><link rel="prefetch" href="/uroborosql-doc/assets/js/16.54f5f0e8.js"><link rel="prefetch" href="/uroborosql-doc/assets/js/17.01ae3288.js"><link rel="prefetch" href="/uroborosql-doc/assets/js/18.4dbfd977.js"><link rel="prefetch" href="/uroborosql-doc/assets/js/19.7c22bce3.js"><link rel="prefetch" href="/uroborosql-doc/assets/js/20.342d55a8.js"><link rel="prefetch" href="/uroborosql-doc/assets/js/22.1a70090a.js"><link rel="prefetch" href="/uroborosql-doc/assets/js/23.ca60e953.js"><link rel="prefetch" href="/uroborosql-doc/assets/js/24.ed2521ce.js"><link rel="prefetch" href="/uroborosql-doc/assets/js/25.99d36c65.js"><link rel="prefetch" href="/uroborosql-doc/assets/js/26.ff1302ba.js"><link rel="prefetch" href="/uroborosql-doc/assets/js/27.cbd178be.js"><link rel="prefetch" href="/uroborosql-doc/assets/js/28.fea1b4b5.js"><link rel="prefetch" href="/uroborosql-doc/assets/js/29.94e68e8d.js"><link rel="prefetch" href="/uroborosql-doc/assets/js/3.fa3047aa.js"><link rel="prefetch" href="/uroborosql-doc/assets/js/30.7f388868.js"><link rel="prefetch" href="/uroborosql-doc/assets/js/31.ee020ea9.js"><link rel="prefetch" href="/uroborosql-doc/assets/js/32.ab7b2f99.js"><link rel="prefetch" href="/uroborosql-doc/assets/js/5.ca5d7e4a.js"><link rel="prefetch" href="/uroborosql-doc/assets/js/6.7379f149.js"><link rel="prefetch" href="/uroborosql-doc/assets/js/7.e8daa71e.js"><link rel="prefetch" href="/uroborosql-doc/assets/js/8.cb08bcb2.js"><link rel="prefetch" href="/uroborosql-doc/assets/js/9.90d3084a.js">
    <link rel="stylesheet" href="/uroborosql-doc/assets/css/0.styles.951fff52.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/uroborosql-doc/" class="home-link router-link-active"><img src="/uroborosql-doc/images/logo.png" alt="uroboroSQL" class="logo"> <span class="site-name can-hide">uroboroSQL</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/uroborosql-doc/" class="nav-link">Home</a></div><div class="nav-item"><a href="/uroborosql-doc/getting_started/" class="nav-link">Getting Started</a></div><div class="nav-item"><a href="/uroborosql-doc/basics/" class="nav-link">基本操作</a></div><div class="nav-item"><a href="/uroborosql-doc/configuration/" class="nav-link router-link-active">設定</a></div><div class="nav-item"><a href="/uroborosql-doc/advanced/" class="nav-link">高度な操作</a></div><div class="nav-item"><a href="/uroborosql-doc/developer_tools/" class="nav-link">Developer Tools</a></div> <a href="https://github.com/future-architect/uroborosql" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/uroborosql-doc/" class="nav-link">Home</a></div><div class="nav-item"><a href="/uroborosql-doc/getting_started/" class="nav-link">Getting Started</a></div><div class="nav-item"><a href="/uroborosql-doc/basics/" class="nav-link">基本操作</a></div><div class="nav-item"><a href="/uroborosql-doc/configuration/" class="nav-link router-link-active">設定</a></div><div class="nav-item"><a href="/uroborosql-doc/advanced/" class="nav-link">高度な操作</a></div><div class="nav-item"><a href="/uroborosql-doc/developer_tools/" class="nav-link">Developer Tools</a></div> <a href="https://github.com/future-architect/uroborosql" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Why uroboroSQL</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Getting Started</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>前提知識</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>基本操作</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>設定</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/uroborosql-doc/configuration/" class="sidebar-link">SqlConfigの生成</a></li><li><a href="/uroborosql-doc/configuration/connection-supplier.html" class="sidebar-link">ConnectionSupplier</a></li><li><a href="/uroborosql-doc/configuration/sql-context-factory.html" class="sidebar-link">SqlContextFactory</a></li><li><a href="/uroborosql-doc/configuration/sql-agent-factory.html" class="active sidebar-link">SqlAgentFactory</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/uroborosql-doc/configuration/sql-agent-factory.html#フェッチサイズと検索タイムアウト設定-sqlagentfactory-setfetchsize-setquerytimeout" class="sidebar-link">フェッチサイズと検索タイムアウト設定 ( SqlAgentFactory#setFetchSize /#setQueryTimeout  )</a></li><li class="sidebar-sub-header"><a href="/uroborosql-doc/configuration/sql-agent-factory.html#例外発生時のログ出力を行うかどうかを設定-sqlagentfactory-setoutputexceptionlog" class="sidebar-link">例外発生時のログ出力を行うかどうかを設定 ( SqlAgentFactory#setOutputExceptionLog )</a></li><li class="sidebar-sub-header"><a href="/uroborosql-doc/configuration/sql-agent-factory.html#sql-idの置換文字列設定-sqlagentfactory-setsqlidkeyname" class="sidebar-link">SQL_IDの置換文字列設定 ( SqlAgentFactory#setSqlIdKeyName )</a></li><li class="sidebar-sub-header"><a href="/uroborosql-doc/configuration/sql-agent-factory.html#caseformatの初期値設定-sqlagentfactory-setdefaultmapkeycaseformat" class="sidebar-link">CaseFormatの初期値設定 ( SqlAgentFactory#setDefaultMapKeyCaseFormat )</a></li><li class="sidebar-sub-header"><a href="/uroborosql-doc/configuration/sql-agent-factory.html#複数件挿入時の挿入方法の初期値設定-sqlagentfactory-setdefaultinsertstype" class="sidebar-link">複数件挿入時の挿入方法の初期値設定 ( SqlAgentFactory#setDefaultInsertsType )</a></li><li class="sidebar-sub-header"><a href="/uroborosql-doc/configuration/sql-agent-factory.html#sql実行のリトライ-sqlagentfactory-setsqlretrycodelist-setdefaultmaxretrycount-setdefaultsqlretrywaittime" class="sidebar-link">SQL実行のリトライ ( SqlAgentFactory#setSqlRetryCodeList /#setDefaultMaxRetryCount /#setDefaultSqlRetryWaitTime )</a></li><li class="sidebar-sub-header"><a href="/uroborosql-doc/configuration/sql-agent-factory.html#db更新処理をトランザクション内のみに強制-sqlagentfactory-setforceupdatewithintransaction" class="sidebar-link">DB更新処理をトランザクション内のみに強制 ( SqlAgentFactory#setForceUpdateWithinTransaction )</a></li><li class="sidebar-sub-header"><a href="/uroborosql-doc/configuration/sql-agent-factory.html#明示的な行ロック時の待機時間-s-のデフォルト値設定-sqlagentfactory-setdefaultforupdatewaitseconds" class="sidebar-link">明示的な行ロック時の待機時間(s)のデフォルト値設定 ( SqlAgentFactory#setDefaultForUpdateWaitSeconds )</a></li></ul></li><li><a href="/uroborosql-doc/configuration/sql-manager.html" class="sidebar-link">SqlManager</a></li><li><a href="/uroborosql-doc/configuration/sql-filter-manager.html" class="sidebar-link">SqlFilterManager</a></li><li><a href="/uroborosql-doc/configuration/entity-handler.html" class="sidebar-link">EntityHandler</a></li><li><a href="/uroborosql-doc/configuration/dialect.html" class="sidebar-link">Dialect</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>高度な操作</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/uroborosql-doc/developer_tools/" class="sidebar-link">Developer Tools</a></li><li><a href="/uroborosql-doc/developer_guide/" class="sidebar-link">開発者ガイド</a></li><li><a href="/uroborosql-doc/license/" class="sidebar-link">License</a></li><li><a href="/uroborosql-doc/about/" class="sidebar-link">uroboroSQLについて</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="sqlagentfactory"><a href="#sqlagentfactory" aria-hidden="true" class="header-anchor">#</a> SqlAgentFactory</h1> <p>SQL実行を行うクラスである<code>SqlAgent</code>を生成するファクトリクラスです。SQL実行時の挙動を変更するための初期値の設定が行えます。</p> <p>設定例</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">SqlConfig</span> config <span class="token operator">=</span> <span class="token class-name">UroboroSQL</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
  <span class="token comment">// SqlAgentFactoryの設定</span>
  <span class="token punctuation">.</span><span class="token function">setSqlAgentFactory</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SqlAgentFactoryImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// JDBCフェッチサイズ</span>
    <span class="token punctuation">.</span><span class="token function">setFetchSize</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span>
    <span class="token comment">// Statementオブジェクトの検索タイムアウト時間(s)</span>
    <span class="token punctuation">.</span><span class="token function">setQueryTimeout</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
    <span class="token comment">// 例外発生時のログ出力を行うかどうか</span>
    <span class="token punctuation">.</span><span class="token function">setOutputExceptionLog</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token comment">// SQL_IDの置換文字列</span>
    <span class="token punctuation">.</span><span class="token function">setSqlIdKeyName</span><span class="token punctuation">(</span><span class="token string">&quot;_SQL_ID_&quot;</span><span class="token punctuation">)</span>
    <span class="token comment">// 検索結果を格納するMapのキー変換に使用するCaseFormatの初期値</span>
    <span class="token punctuation">.</span><span class="token function">setDefaultMapKeyCaseFormat</span><span class="token punctuation">(</span><span class="token class-name">CaseFormat</span><span class="token punctuation">.</span>UPPER_SNAKE_CASE<span class="token punctuation">)</span>
    <span class="token comment">// 複数件挿入時の挿入方法の初期値</span>
    <span class="token punctuation">.</span><span class="token function">setDefaultInsertsType</span><span class="token punctuation">(</span><span class="token class-name">InsertsType</span><span class="token punctuation">.</span>BULK<span class="token punctuation">)</span>
    <span class="token comment">// アプリケーション全体のリトライ設定</span>
    <span class="token comment">// SQLエラーコードが54,30006のいずれか(Oracleのリソース・ビジー)の場合</span>
    <span class="token punctuation">.</span><span class="token function">setSqlRetryCodeList</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">&quot;54&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;30006&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// 最大リトライ回数</span>
    <span class="token punctuation">.</span><span class="token function">setDefaultMaxRetryCount</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
    <span class="token comment">// リトライ間隔</span>
    <span class="token punctuation">.</span><span class="token function">setDefaultSqlRetryWaitTime</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
    <span class="token comment">// トランザクション内での更新を強制するかどうか</span>
    <span class="token punctuation">.</span><span class="token function">setForceUpdateWithinTransaction</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token comment">// 明示的な行ロック時の待機時間(s)デフォルト値</span>
    <span class="token punctuation">.</span><span class="token function">setDefaultForUpdateWaitSeconds</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><h2 id="フェッチサイズと検索タイムアウト設定-sqlagentfactory-setfetchsize-setquerytimeout"><a href="#フェッチサイズと検索タイムアウト設定-sqlagentfactory-setfetchsize-setquerytimeout" aria-hidden="true" class="header-anchor">#</a> フェッチサイズと検索タイムアウト設定 ( <code>SqlAgentFactory#setFetchSize</code> /<code>#setQueryTimeout</code>  )</h2> <p><code>SqlAgent</code>で検索処理を行う際、データベースから一度に取得する行数（<code>fetchSize</code>）や
検索タイムアウト時間（秒）（<code>queryTimeout</code>）の初期値を指定することが出来ます。
指定しない場合<code>fetchSize</code>, <code>queryTimeout</code>ともに<code>-1</code>が設定されます。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">SqlConfig</span> config <span class="token operator">=</span> <span class="token class-name">UroboroSQL</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
  <span class="token comment">// SqlAgentFactoryの設定</span>
  <span class="token punctuation">.</span><span class="token function">setSqlAgentFactory</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SqlAgentFactoryImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// JDBCフェッチサイズ</span>
    <span class="token punctuation">.</span><span class="token function">setFetchSize</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span>
    <span class="token comment">// Statementオブジェクトの検索タイムアウト時間(s)</span>
    <span class="token punctuation">.</span><span class="token function">setQueryTimeout</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><div class="warning custom-block"><p class="custom-block-title">補足</p> <p><code>fetchSize</code>は、<a href="https://docs.oracle.com/javase/jp/8/docs/api/java/sql/Statement.html#setFetchSize-int-" target="_blank" rel="noopener noreferrer">Statement.setFetchSize<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>に渡される値で、パフォーマンスに影響します。<br>
JDBCクライアント（uroborosqlを使用しているJavaアプリケーション）ではDBサーバ側で実行されたSELECTの結果セットをfetchサイズで指定された行数ずつ分割して取得します。
そのため結果行数に対して<code>fetchSize</code>が小さいと、JDBCクライアント &lt;-&gt; DBサーバ間の通信回数が増大してパフォーマンスに悪影響を及ぼします。<br>
（例：select結果が10,000件、fetchSizeが100の場合、JDBCクライアント⇔DBサーバ間の通信は10,000÷100 = 100回行われる）</p></div> <div class="danger custom-block"><p class="custom-block-title">注意</p> <p><code>fetchSize</code>はcollect/foreachメソッドで返却される結果セットの行数を制限する設定ではありません。</p></div> <h2 id="例外発生時のログ出力を行うかどうかを設定-sqlagentfactory-setoutputexceptionlog"><a href="#例外発生時のログ出力を行うかどうかを設定-sqlagentfactory-setoutputexceptionlog" aria-hidden="true" class="header-anchor">#</a> 例外発生時のログ出力を行うかどうかを設定 ( <code>SqlAgentFactory#setOutputExceptionLog</code> )</h2> <p>SQL実行時にSQL例外が発生した場合に、発生した例外と実行したSQLの詳細情報を出力するかどうかを指定できます。
指定しない場合<code>false</code>になります。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">SqlConfig</span> config <span class="token operator">=</span> <span class="token class-name">UroboroSQL</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
  <span class="token comment">// SqlAgentFactoryの設定</span>
  <span class="token punctuation">.</span><span class="token function">setSqlAgentFactory</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SqlAgentFactoryImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 例外発生時のログ出力を行うかどうか</span>
    <span class="token punctuation">.</span><span class="token function">setOutputExceptionLog</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h2 id="sql-idの置換文字列設定-sqlagentfactory-setsqlidkeyname"><a href="#sql-idの置換文字列設定-sqlagentfactory-setsqlidkeyname" aria-hidden="true" class="header-anchor">#</a> SQL_IDの置換文字列設定 ( <code>SqlAgentFactory#setSqlIdKeyName</code> )</h2> <p>SQL文に特定の置換文字列をSQLコメントとして記述することで、SQL実行時に実行したSQLの元となるSQLファイルを特定するための
情報（SQL_ID）を埋め込むことが出来ます。SQL_IDを埋め込むことでSQLログやDBのSQL履歴で実行されたSQLの元となるファイルを
特定しやすくなります。<br>
必要に応じてこの置換文字列は変更することが出来ます。
指定しない場合<code>_SQL_ID_</code>になります。</p> <p>設定例</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">SqlConfig</span> config <span class="token operator">=</span> <span class="token class-name">UroboroSQL</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
  <span class="token comment">// SqlAgentFactoryの設定</span>
  <span class="token punctuation">.</span><span class="token function">setSqlAgentFactory</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SqlAgentFactoryImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// SQL_IDの置換文字列</span>
    <span class="token punctuation">.</span><span class="token function">setSqlIdKeyName</span><span class="token punctuation">(</span><span class="token string">&quot;_SQL_ID_&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>department/select_department.sql</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token comment">/* _SQL_ID_ */</span>  <span class="token comment">-- _SQL_ID_ がSQLファイルを特定するための情報の埋め込み先となる</span>
  dept<span class="token punctuation">.</span>dept_no      <span class="token keyword">as</span>  dept_no
<span class="token punctuation">,</span> dept<span class="token punctuation">.</span>dept_name    <span class="token keyword">as</span>  dept_name
<span class="token punctuation">,</span> dept<span class="token punctuation">.</span>lock_version <span class="token keyword">as</span>  lock_version
<span class="token keyword">from</span>
  department  dept
<span class="token comment">/*BEGIN*/</span>
<span class="token keyword">where</span>
<span class="token comment">/*IF SF.isNotEmpty(deptNo)*/</span>
<span class="token operator">and</span> dept<span class="token punctuation">.</span>dept_no  <span class="token operator">=</span> <span class="token comment">/*deptNo*/</span><span class="token number">1</span>
<span class="token comment">/*END*/</span>
<span class="token comment">/*IF SF.isNotEmpty(deptName)*/</span>
<span class="token operator">and</span> dept<span class="token punctuation">.</span>dept_name  <span class="token operator">=</span> <span class="token comment">/*deptName*/</span><span class="token string">'sample'</span>
<span class="token comment">/*END*/</span>
<span class="token comment">/*END*/</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>SQL実行処理</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>agent<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">&quot;department/select_department&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">param</span><span class="token punctuation">(</span><span class="token string">&quot;deptNo&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>実行されるSQL</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token comment">/* department/select_department */</span>  <span class="token comment">-- _SQL_ID_ にSQL名（department/select_department）が設定される</span>
  dept<span class="token punctuation">.</span>dept_no      <span class="token keyword">as</span>  dept_no
<span class="token punctuation">,</span> dept<span class="token punctuation">.</span>dept_name    <span class="token keyword">as</span>  dept_name
<span class="token punctuation">,</span> dept<span class="token punctuation">.</span>lock_version <span class="token keyword">as</span>  lock_version
<span class="token keyword">from</span>
  department  dept
<span class="token keyword">where</span>
  dept<span class="token punctuation">.</span>dept_no  <span class="token operator">=</span> <span class="token number">1</span><span class="token comment">/*deptNo*/</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h2 id="caseformatの初期値設定-sqlagentfactory-setdefaultmapkeycaseformat"><a href="#caseformatの初期値設定-sqlagentfactory-setdefaultmapkeycaseformat" aria-hidden="true" class="header-anchor">#</a> CaseFormatの初期値設定 ( <code>SqlAgentFactory#setDefaultMapKeyCaseFormat</code> )</h2> <p>SQLによる検索で、以下のメソッドを使用して<code>List&lt;Map&lt;String, Object&gt;&gt;</code>や<code>Map&lt;String, Object&gt;</code>を取得する際、
取得したMapのキー名に対する書式の初期値を指定することが出来ます。
指定しない場合<code>CaseFormat.UPPER_SNAKE_CASE</code>になります。</p> <table><thead><tr><th style="text-align:left;">対象メソッド</th> <th style="text-align:left;">戻り値の型</th></tr></thead> <tbody><tr><td style="text-align:left;">SqlQuery#collect()</td> <td style="text-align:left;">List&lt;Map&lt;String, Object&gt;&gt;</td></tr> <tr><td style="text-align:left;">SqlQuery#findFirst()</td> <td style="text-align:left;">Optional&lt;Map&lt;String, Object&gt;&gt;</td></tr> <tr><td style="text-align:left;">SqlQuery#first()</td> <td style="text-align:left;">Map&lt;String, Object&gt;</td></tr> <tr><td style="text-align:left;">SqlQuery#stream()</td> <td style="text-align:left;">Stream&lt;Map&lt;String, Object&gt;&gt;</td></tr></tbody></table> <p>指定しない場合（初期設定：<code>CaseFormat.UPPER_SNAKE_CASE</code>）</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>agent<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">&quot;department/select_department&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 結果(departments) キーがUPPER_SNAKE_CASEとなっている</span>
<span class="token punctuation">[</span>
 <span class="token punctuation">{</span><span class="token string">&quot;DEPT_NO&quot;</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;DEPT_NAME&quot;</span><span class="token operator">=</span><span class="token string">&quot;sales&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
 <span class="token punctuation">{</span><span class="token string">&quot;DEPT_NO&quot;</span><span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">&quot;DEPT_NAME&quot;</span><span class="token operator">=</span><span class="token string">&quot;export&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
 <span class="token punctuation">{</span><span class="token string">&quot;DEPT_NO&quot;</span><span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">&quot;DEPT_NAME&quot;</span><span class="token operator">=</span><span class="token string">&quot;accounting&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
 <span class="token punctuation">{</span><span class="token string">&quot;DEPT_NO&quot;</span><span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">&quot;DEPT_NAME&quot;</span><span class="token operator">=</span><span class="token string">&quot;personnel&quot;</span><span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p><code>CaseFormat.CAMEL_CASE</code>を初期値として設定</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">SqlConfig</span> config <span class="token operator">=</span> <span class="token class-name">UroboroSQL</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
  <span class="token comment">// SqlAgentFactoryの設定</span>
  <span class="token punctuation">.</span><span class="token function">setSqlAgentFactory</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SqlAgentFactoryImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 検索結果を格納するMapのキー変換に使用するCaseFormatの初期値</span>
    <span class="token punctuation">.</span><span class="token function">setDefaultMapKeyCaseFormat</span><span class="token punctuation">(</span><span class="token class-name">CaseFormat</span><span class="token punctuation">.</span>CAMEL_CASE<span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code>agent<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">&quot;department/select_department&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 結果(departments) キーがCAMEL_CASEとなっている</span>
<span class="token punctuation">[</span>
 <span class="token punctuation">{</span><span class="token string">&quot;deptNo&quot;</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;deptName&quot;</span><span class="token operator">=</span><span class="token string">&quot;sales&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
 <span class="token punctuation">{</span><span class="token string">&quot;deptNo&quot;</span><span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">&quot;deptName&quot;</span><span class="token operator">=</span><span class="token string">&quot;export&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
 <span class="token punctuation">{</span><span class="token string">&quot;deptNo&quot;</span><span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">&quot;deptName&quot;</span><span class="token operator">=</span><span class="token string">&quot;accounting&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
 <span class="token punctuation">{</span><span class="token string">&quot;deptNo&quot;</span><span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">&quot;deptName&quot;</span><span class="token operator">=</span><span class="token string">&quot;personnel&quot;</span><span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h2 id="複数件挿入時の挿入方法の初期値設定-sqlagentfactory-setdefaultinsertstype"><a href="#複数件挿入時の挿入方法の初期値設定-sqlagentfactory-setdefaultinsertstype" aria-hidden="true" class="header-anchor">#</a> 複数件挿入時の挿入方法の初期値設定 ( <code>SqlAgentFactory#setDefaultInsertsType</code> )</h2> <p><code>SqlAgent#inserts()</code>メソッドで使用する<a href="/uroborosql-doc/basics/entity-api.html#挿入方法（insertstype）の指定">InsertsType</a>の初期値を設定することが出来ます。
指定しない場合<code>InsertsType.BULK</code>になります。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">SqlConfig</span> config <span class="token operator">=</span> <span class="token class-name">UroboroSQL</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
  <span class="token comment">// SqlAgentFactoryの設定</span>
  <span class="token punctuation">.</span><span class="token function">setSqlAgentFactory</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SqlAgentFactoryImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 複数件挿入時の挿入方法の初期値</span>
    <span class="token punctuation">.</span><span class="token function">setDefaultInsertsType</span><span class="token punctuation">(</span><span class="token class-name">InsertsType</span><span class="token punctuation">.</span>BULK<span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h2 id="sql実行のリトライ-sqlagentfactory-setsqlretrycodelist-setdefaultmaxretrycount-setdefaultsqlretrywaittime"><a href="#sql実行のリトライ-sqlagentfactory-setsqlretrycodelist-setdefaultmaxretrycount-setdefaultsqlretrywaittime" aria-hidden="true" class="header-anchor">#</a> SQL実行のリトライ ( <code>SqlAgentFactory#setSqlRetryCodeList</code> /<code>#setDefaultMaxRetryCount</code> /<code>#setDefaultSqlRetryWaitTime</code> )</h2> <p>SQLを実行した際、タイミングによって発生する例外（テーブルロックエラーなど）の場合はリトライを行い、
できるだけ正常に処理を終了させたい場合があります。<br>
通常、このようなケースでは以下のような実装を行います。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">String</span> MAX_RETRY_COUNT <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token comment">// MAX_RETRY_COUNT はアプリケーションで定義された最大リトライ回数の定数とする</span>
<span class="token class-name">SqlConfig</span> config <span class="token operator">=</span> <span class="token class-name">UroboroSQL</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> retryCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">SqlAgent</span> agent <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">agent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// INSERT文の実行</span>
    <span class="token comment">// insert into product (product_id) values (/*product_id*/0);</span>
    agent<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token string">&quot;example/insert_product&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">param</span><span class="token punctuation">(</span><span class="token string">&quot;product_id&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">UroborosqlSQLException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// SQLExceptionが発生した際に行う処理を実装</span>
    <span class="token keyword">int</span> errorCode <span class="token operator">=</span> ex<span class="token punctuation">.</span><span class="token function">getErrorCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>errorCode <span class="token operator">==</span> <span class="token number">30006</span> <span class="token operator">||</span> errorCode <span class="token operator">==</span> <span class="token number">54</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// リソース・ビジー(Oracleの場合)</span>
      <span class="token comment">// リトライ対象エラーコードの場合はリトライカウントをカウントアップしてリトライする</span>
      retryCount<span class="token operator">++</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>retryCount <span class="token operator">==</span> MAX_RETRY_COUNT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 最大リトライ回数に達した場合は例外をスローする</span>
        <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token comment">// 10ms 待機</span>
          <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> iex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// do nothing</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// リトライ対象エラーコード以外はすぐに例外をスローする</span>
      <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p>しかし、上記のようなリトライ処理を個々の実装で行うと、
実装漏れや実装ミス、実装方法の差異（for()の代わりにwhile()を使用するなど）により不具合が発生しやすくなります。<br> <strong>uroboroSQL</strong>では、アプリケーション全体のリトライ設定と、全体設定より優先される個別処理でのリトライ用APIの
2種類のAPIを提供することで、より簡潔で確実なリトライ処理が行えるよう工夫されています。<br>
アプリケーション全体のリトライ設定は<code>SqlAgentFactory</code>生成時に行います。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">SqlConfig</span> config <span class="token operator">=</span> <span class="token class-name">UroboroSQL</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
  <span class="token comment">// SqlAgentFactoryの設定</span>
  <span class="token punctuation">.</span><span class="token function">setSqlAgentFactory</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SqlAgentFactoryImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// アプリケーション全体のリトライ設定</span>
    <span class="token comment">// SQLエラーコードが54,30006のいずれか(Oracleのリソース・ビジー)の場合</span>
    <span class="token punctuation">.</span><span class="token function">setSqlRetryCodeList</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">&quot;54&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;30006&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// 最大リトライ回数（3回）リトライ</span>
    <span class="token punctuation">.</span><span class="token function">setDefaultMaxRetryCount</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
    <span class="token comment">// リトライ間隔10ms待機</span>
    <span class="token punctuation">.</span><span class="token function">setDefaultSqlRetryWaitTime</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>リトライAPIを用いた実装は次のようになります。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// アプリケーション全体のリトライ設定に従ってリトライを行う。（個別のリトライ指定なし）</span>
<span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">SqlAgent</span> agent <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">agent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// INSERT文の実行</span>
  <span class="token comment">// insert into product (product_id) values (/*product_id*/0);</span>
  agent<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token string">&quot;example/insert_product&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">param</span><span class="token punctuation">(</span><span class="token string">&quot;product_id&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 個別にリトライ設定を上書きする（retry()を利用）</span>
<span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">SqlAgent</span> agent <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">agent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// INSERT文の実行</span>
  <span class="token comment">// insert into product (product_id) values (/*product_id*/0);</span>
  <span class="token comment">// リトライ対象エラーコードの場合、5回のリトライを20ms間隔で行う</span>
  agent<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token string">&quot;example/insert_product&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">param</span><span class="token punctuation">(</span><span class="token string">&quot;product_id&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">retry</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h2 id="db更新処理をトランザクション内のみに強制-sqlagentfactory-setforceupdatewithintransaction"><a href="#db更新処理をトランザクション内のみに強制-sqlagentfactory-setforceupdatewithintransaction" aria-hidden="true" class="header-anchor">#</a> DB更新処理をトランザクション内のみに強制 ( <code>SqlAgentFactory#setForceUpdateWithinTransaction</code> ) <span class="badge tip" style="vertical-align:top;" data-v-c13ee5b0>0.14.0+</span></h2> <p>複数のDB更新処理をまとめて行う際、途中で例外が発生するとDBデータが不整合な状態になる場合があります。このようなデータ不整合を防ぐためには<a href="/uroborosql-doc/transaction.html#トランザクション">トランザクション</a>を利用します。<br>
しかし、通常の設定ではトランザクションを開始しない状態でもDB更新処理を行うことが可能になっているため不具合に気付きにくいという問題があります。<br> <strong>uroboroSQL</strong>ではトランザクションを開始していない状態でDB更新処理が行なわれた場合に例外をスローするオプションを提供しています。このオプションを使用することでDBデータの整合性を維持しやすくなります。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">SqlConfig</span> config <span class="token operator">=</span> <span class="token class-name">UroboroSQL</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
  <span class="token comment">// SqlAgentFactoryの設定</span>
  <span class="token punctuation">.</span><span class="token function">setSqlAgentFactory</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SqlAgentFactoryImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// トランザクション内での更新を強制するかどうか</span>
    <span class="token punctuation">.</span><span class="token function">setForceUpdateWithinTransaction</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><code>SqlAgentFactory#setForceUpdateWithinTransaction()</code>に<code>true</code>を指定することでトランザクションを開始していない状態でDB更新処理が行なわれた場合に<code>UroborosqlTransactionException</code>がスローされます。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>agent<span class="token punctuation">.</span><span class="token function">required</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// トランザクション開始</span>
  <span class="token comment">// トランザクション内でのDB更新なのでOK</span>
  agent<span class="token punctuation">.</span><span class="token function">updateWith</span><span class="token punctuation">(</span><span class="token string">&quot;insert into employee (emp_no) values (/*emp_no*/1001)&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">param</span><span class="token punctuation">(</span><span class="token string">&quot;emp_no&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>　<span class="token comment">// トランザクション終了</span>

<span class="token comment">// トランザクション外でのDB更新なので UroborosqlTransactionException がスローされる</span>
agent<span class="token punctuation">.</span><span class="token function">updateWith</span><span class="token punctuation">(</span><span class="token string">&quot;insert into department (dept_no, dept_name) values (/*dept_no*/1111, /*dept_name*/'Sales')&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">param</span><span class="token punctuation">(</span><span class="token string">&quot;dept_no&quot;</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">param</span><span class="token punctuation">(</span><span class="token string">&quot;dept_name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;export&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h2 id="明示的な行ロック時の待機時間-s-のデフォルト値設定-sqlagentfactory-setdefaultforupdatewaitseconds"><a href="#明示的な行ロック時の待機時間-s-のデフォルト値設定-sqlagentfactory-setdefaultforupdatewaitseconds" aria-hidden="true" class="header-anchor">#</a> 明示的な行ロック時の待機時間(s)のデフォルト値設定 ( <code>SqlAgentFactory#setDefaultForUpdateWaitSeconds</code> ) <span class="badge tip" style="vertical-align:top;" data-v-c13ee5b0>0.14.0+</span></h2> <p><code>SqlEntityQuery#forUpdateWait()</code>による明示的な行ロックをおこなう際の待機時間を指定することができます。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">SqlConfig</span> config <span class="token operator">=</span> <span class="token class-name">UroboroSQL</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
  <span class="token comment">// SqlAgentFactoryの設定</span>
  <span class="token punctuation">.</span><span class="token function">setSqlAgentFactory</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SqlAgentFactoryImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 明示的な行ロック時の待機時間(s)デフォルト値</span>
    <span class="token punctuation">.</span><span class="token function">setDefaultForUpdateWaitSeconds</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>待機時間の初期値を設定することで<code>SqlEntityQuery#forUpdateWait()</code>を発行する際に適用され、
待機時間を都度指定する必要がなくなります。<br> <code>SqlEntityQuery#forUpdateWait(int)</code>を使って個別に待機時間を指定した場合は個別設定が優先されます。</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/future-architect/uroborosql-doc/edit/master/src/configuration/sql-agent-factory.md" target="_blank" rel="noopener noreferrer">Edit this page</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">2020-3-8 21:44:34</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/uroborosql-doc/configuration/sql-context-factory.html" class="prev">
          SqlContextFactory
        </a></span> <span class="next"><a href="/uroborosql-doc/configuration/sql-manager.html">
          SqlManager
        </a>
        →
      </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/uroborosql-doc/assets/js/app.92bd86c5.js" defer></script><script src="/uroborosql-doc/assets/js/2.8444be12.js" defer></script><script src="/uroborosql-doc/assets/js/21.aeb25471.js" defer></script><script src="/uroborosql-doc/assets/js/4.e334faa4.js" defer></script>
  </body>
</html>
