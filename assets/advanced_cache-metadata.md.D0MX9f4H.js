import{_ as e,C as i,o as n,c as l,j as s,a as r,E as d,a2 as o}from"./chunks/framework.DuVu33VI.js";const E=JSON.parse('{"title":"メタデータのキャッシュ","description":"","frontmatter":{"head":[["meta",{"name":"og:title","content":"メタデータのキャッシュ"}],["meta",{"name":"og:url","content":"/uroborosql-doc/advanced/cache-metadata.html"}]]},"headers":[],"relativePath":"advanced/cache-metadata.md","filePath":"advanced/cache-metadata.md"}'),p={name:"advanced/cache-metadata.md"};function h(c,a,k,b,u,g){const t=i("CopyOrDownloadAsMarkdownButtons");return n(),l("div",null,[a[0]||(a[0]=s("div",{style:{display:"none"},hidden:"true","aria-hidden":"true"},"Are you an LLM? You can read better optimized documentation at /uroborosql-doc/advanced/cache-metadata.md for this page in Markdown format",-1)),a[1]||(a[1]=s("h1",{id:"メタデータのキャッシュ",tabindex:"-1"},[r("メタデータのキャッシュ "),s("a",{class:"header-anchor",href:"#メタデータのキャッシュ","aria-label":'Permalink to "メタデータのキャッシュ"'},"​")],-1)),d(t),a[2]||(a[2]=o(`<h2 id="概要" tabindex="-1">概要 <a class="header-anchor" href="#概要" aria-label="Permalink to &quot;概要&quot;">​</a></h2><p><strong>uroboroSQL</strong>では、パフォーマンスを向上させるために、各種メタデータをキャッシュする仕組みを提供しています。<br> 開発環境やテスト環境など、メタデータの変更が頻繁に発生する環境では、必要に応じてキャッシュをクリアすることができます。</p><h2 id="キャッシュの種類" tabindex="-1">キャッシュの種類 <a class="header-anchor" href="#キャッシュの種類" aria-label="Permalink to &quot;キャッシュの種類&quot;">​</a></h2><p><strong>uroboroSQL</strong>では以下の3種類のメタデータキャッシュが管理されています。</p><h3 id="tablemetadataキャッシュ" tabindex="-1">TableMetadataキャッシュ <a class="header-anchor" href="#tablemetadataキャッシュ" aria-label="Permalink to &quot;TableMetadataキャッシュ&quot;">​</a></h3><p><code>DefaultEntityHandler</code>で管理されるテーブルメタデータのキャッシュです。</p><h4 id="特徴" tabindex="-1">特徴 <a class="header-anchor" href="#特徴" aria-label="Permalink to &quot;特徴&quot;">​</a></h4><table tabindex="0"><thead><tr><th>項目</th><th>内容</th></tr></thead><tbody><tr><td><strong>キャッシュ対象</strong></td><td>エンティティクラスとテーブル構造の対応情報（カラム名、データ型、主キーなど）</td></tr><tr><td><strong>キャッシュキー</strong></td><td>接続情報（スキーマ・カタログ）とエンティティクラスの組み合わせ</td></tr><tr><td><strong>キャッシュタイプ</strong></td><td>LRUキャッシュ（ConcurrentLruCache）</td></tr><tr><td><strong>デフォルトサイズ</strong></td><td>30エントリ</td></tr></tbody></table><h4 id="サイズの変更" tabindex="-1">サイズの変更 <a class="header-anchor" href="#サイズの変更" aria-label="Permalink to &quot;サイズの変更&quot;">​</a></h4><p>システムプロパティ <code>uroborosql.entity.cache.size</code> でキャッシュサイズを変更できます。</p><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// JVM起動時のオプション</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Duroborosql.entity.cache.size</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">100</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="warning custom-block"><p class="custom-block-title">キャッシュサイズを変更する際の注意点</p><p>キャッシュサイズを大きくすると、キャッシュヒット率が向上しパフォーマンスの改善が見込めます。ただし、その分メモリ消費量が増加します。<br> キャッシュサイズを変更する際は、メモリ使用量を監視し、アプリケーションへの影響がないことを確認してください。</p></div><h4 id="tablemetadataキャッシュのクリア" tabindex="-1">TableMetadataキャッシュのクリア <a class="header-anchor" href="#tablemetadataキャッシュのクリア" aria-label="Permalink to &quot;TableMetadataキャッシュのクリア&quot;">​</a></h4><p>データベースのテーブル構造（カラムの追加・削除・変更）を行った場合、TableMetadataキャッシュに古い情報が残る可能性があります。</p><p><strong>対処方法</strong>: <code>DefaultEntityHandler.clearCache()</code> の実行、またはアプリケーションの再起動</p><p>TableMetadataキャッシュは<code>DefaultEntityHandler</code>の静的フィールドとして保持されています。<br> キャッシュはLRU方式で自動的に管理されるため、古いエントリは自動的に削除されますが、<br><code>DefaultEntityHandler.clearCache()</code> メソッドを使用して明示的にキャッシュをクリアすることもできます。</p><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// DefaultEntityHandlerキャッシュのクリア</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">DefaultEntityHandler.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">clearCache</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="warning custom-block"><p class="custom-block-title">注意事項</p><p><code>DefaultEntityHandler.clearCache()</code> を実行すると、すべてのテーブルメタデータがクリアされます。<br> クリア後の最初のアクセス時には、マッピング情報の再構築が行われるため、処理時間が若干増加します。</p></div><h3 id="mappingcolumnキャッシュ" tabindex="-1">MappingColumnキャッシュ <a class="header-anchor" href="#mappingcolumnキャッシュ" aria-label="Permalink to &quot;MappingColumnキャッシュ&quot;">​</a></h3><p><code>MappingUtils</code>で管理されるエンティティのフィールドとカラムのマッピング情報のキャッシュです。</p><h4 id="特徴-1" tabindex="-1">特徴 <a class="header-anchor" href="#特徴-1" aria-label="Permalink to &quot;特徴&quot;">​</a></h4><table tabindex="0"><thead><tr><th>項目</th><th>内容</th></tr></thead><tbody><tr><td><strong>キャッシュ対象</strong></td><td>エンティティクラスのフィールド情報、アノテーション情報、SQL種別ごとのカラムマッピング</td></tr><tr><td><strong>キャッシュキー</strong></td><td>スキーマ、テーブル名、エンティティクラスの組み合わせ</td></tr><tr><td><strong>キャッシュタイプ</strong></td><td>LRUキャッシュ（ConcurrentLruCache）</td></tr><tr><td><strong>デフォルトサイズ</strong></td><td>30エントリ</td></tr></tbody></table><h4 id="サイズの変更-1" tabindex="-1">サイズの変更 <a class="header-anchor" href="#サイズの変更-1" aria-label="Permalink to &quot;サイズの変更&quot;">​</a></h4><p>システムプロパティ <code>uroborosql.entity.cache.size</code> でキャッシュサイズを変更できます（TableMetadataキャッシュと共通）。</p><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// JVM起動時のオプション</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Duroborosql.entity.cache.size</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">100</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="warning custom-block"><p class="custom-block-title">キャッシュサイズを変更する際の注意点</p><p>キャッシュサイズを大きくすると、キャッシュヒット率が向上しパフォーマンスの改善が見込めます。ただし、その分メモリ消費量が増加します。<br> キャッシュサイズを変更する際は、メモリ使用量を監視し、アプリケーションへの影響がないことを確認してください。</p></div><h4 id="mappingcolumnキャッシュのクリア" tabindex="-1">MappingColumnキャッシュのクリア <a class="header-anchor" href="#mappingcolumnキャッシュのクリア" aria-label="Permalink to &quot;MappingColumnキャッシュのクリア&quot;">​</a></h4><p>エンティティクラスのフィールドやアノテーションを変更した場合、MappingColumnキャッシュのクリアが必要です。</p><p><strong>対処方法</strong>: <code>MappingUtils.clearCache()</code> の実行、またはアプリケーションの再起動</p><p>MappingColumnキャッシュは<code>MappingUtils</code>の静的フィールドとして保持されています。<br> キャッシュはLRU方式で自動的に管理されるため、古いエントリは自動的に削除されますが、<br><code>MappingUtils.clearCache()</code> メソッドを使用して明示的にキャッシュをクリアすることもできます。</p><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// MappingColumnキャッシュのクリア</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MappingUtils.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">clearCache</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="warning custom-block"><p class="custom-block-title">注意事項</p><p><code>MappingUtils.clearCache()</code> を実行すると、すべてのエンティティクラスのマッピング情報がクリアされます。<br> クリア後の最初のアクセス時には、マッピング情報の再構築が行われるため、処理時間が若干増加します。</p></div><h3 id="sql情報キャッシュ" tabindex="-1">SQL情報キャッシュ <a class="header-anchor" href="#sql情報キャッシュ" aria-label="Permalink to &quot;SQL情報キャッシュ&quot;">​</a></h3><p><code>SqlResourceManager</code>で管理されるSQLファイルの内容とメタデータのキャッシュです。</p><h4 id="特徴-2" tabindex="-1">特徴 <a class="header-anchor" href="#特徴-2" aria-label="Permalink to &quot;特徴&quot;">​</a></h4><table tabindex="0"><thead><tr><th>項目</th><th>内容</th></tr></thead><tbody><tr><td><strong>キャッシュ対象</strong></td><td>SQLファイルの内容（SQL文）、ファイルURL、ファイルスキーマ情報</td></tr><tr><td><strong>キャッシュキー</strong></td><td>SQL名</td></tr><tr><td><strong>キャッシュタイプ</strong></td><td>ConcurrentHashMap</td></tr><tr><td><strong>デフォルトサイズ</strong></td><td>無制限（読み込んだすべてのSQLファイルをキャッシュ）</td></tr></tbody></table><h4 id="sqlファイルの変更" tabindex="-1">SQLファイルの変更 <a class="header-anchor" href="#sqlファイルの変更" aria-label="Permalink to &quot;SQLファイルの変更&quot;">​</a></h4><p>アプリケーションを起動した状態でSQLファイルの内容を変更した場合、SQL情報キャッシュのクリアまたは再読み込みが必要です。</p><p><strong>対処方法</strong>:<code>SqlResourceManager.clearCache()</code> の実行、またはアプリケーションの再起動</p><h4 id="sql情報キャッシュのクリア" tabindex="-1">SQL情報キャッシュのクリア <a class="header-anchor" href="#sql情報キャッシュのクリア" aria-label="Permalink to &quot;SQL情報キャッシュのクリア&quot;">​</a></h4><p><code>SqlResourceManager.clearCache()</code> メソッドを使用して、すべてのSQLキャッシュをクリアできます。</p><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">SqlConfig config </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> UroboroSQL.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">builder</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;jdbc:h2:mem:test&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;sa&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">build</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// すべてのSQLキャッシュをクリア</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">config.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getSqlResourceManager</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">clearCache</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="本番環境での注意事項" tabindex="-1">本番環境での注意事項 <a class="header-anchor" href="#本番環境での注意事項" aria-label="Permalink to &quot;本番環境での注意事項&quot;">​</a></h2><div class="warning custom-block"><p class="custom-block-title">WARNING</p><p>本番環境では、キャッシュクリアによる一時的なパフォーマンス低下が発生する可能性があります。<br> 以下の点に注意してください：</p><ul><li>キャッシュクリア直後は、メタデータの再取得やSQLファイルの再読み込みが発生するため、レスポンスタイムが増加します</li><li>高負荷時のキャッシュクリアは避け、メンテナンスウィンドウなどの適切なタイミングで実施してください</li><li>可能であれば、アプリケーションの再デプロイによるキャッシュのリフレッシュを推奨します</li></ul></div>`,44))])}const y=e(p,[["render",h]]);export{E as __pageData,y as default};
