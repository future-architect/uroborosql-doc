import{_ as n,C as l,o as t,c as e,j as i,a as p,E as h,a2 as r}from"./chunks/framework.DuVu33VI.js";const b=JSON.parse('{"title":"ベストプラクティス","description":"","frontmatter":{"head":[["meta",{"name":"og:title","content":"ベストプラクティス"}],["meta",{"name":"og:url","content":"/uroborosql-doc/best_practices/"}]]},"headers":[],"relativePath":"best_practices/index.md","filePath":"best_practices/index.md"}'),k={name:"best_practices/index.md"};function d(E,s,c,o,g,u){const a=l("CopyOrDownloadAsMarkdownButtons");return t(),e("div",null,[s[0]||(s[0]=i("div",{style:{display:"none"},hidden:"true","aria-hidden":"true"},"Are you an LLM? You can read better optimized documentation at /uroborosql-doc/best_practices.md for this page in Markdown format",-1)),s[1]||(s[1]=i("h1",{id:"ベストプラクティス",tabindex:"-1"},[p("ベストプラクティス "),i("a",{class:"header-anchor",href:"#ベストプラクティス","aria-label":'Permalink to "ベストプラクティス"'},"​")],-1)),h(a),s[2]||(s[2]=r(`<p><strong>uroboroSQL</strong> を使用してSQLを実行する際のベストプラクティスについて説明します。</p><ol><li><a href="#_1-resultsetの扱いによるメモリ効率の差異-collect-streamの違い">ResultSetの扱いによるメモリ効率の差異</a></li><li><a href="#_2-select-insertやselect-updateの実装方式の違い">SELECT-INSERTやSELECT-UPDATEの実装方式の違い</a></li><li><a href="#_3-バッチ処理とバルク処理の違い">バッチ処理とバルク処理の違い</a></li><li><a href="#_4-バッチ件数による性能の違い">バッチ件数による性能の違い</a></li></ol><h2 id="_1-resultsetの扱いによるメモリ効率の差異-collect-streamの違い" tabindex="-1">1. ResultSetの扱いによるメモリ効率の差異(collect, streamの違い) <a class="header-anchor" href="#_1-resultsetの扱いによるメモリ効率の差異-collect-streamの違い" aria-label="Permalink to &quot;1. ResultSetの扱いによるメモリ効率の差異(collect, streamの違い)&quot;">​</a></h2><p><strong>uroboroSQL</strong> では、検索結果の取得方法として <code>collect()</code> と <code>stream()</code> の2つのメソッドが提供されています。これらは内部的なResultSetの処理方法が異なり、メモリ使用量に大きな影響を与えます。</p><h3 id="collect-メソッドの特徴" tabindex="-1">collect()メソッドの特徴 <a class="header-anchor" href="#collect-メソッドの特徴" aria-label="Permalink to &quot;collect()メソッドの特徴&quot;">​</a></h3><p><code>collect()</code> メソッドは、検索結果を <strong>すべてメモリ上に読み込んでからList形式で返却</strong> します。</p><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// すべての検索結果をメモリに読み込む</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">List&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Product</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; products </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> agent.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">query</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Product.class)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">collect</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>メモリ使用の特徴:</strong></p><ul><li>検索結果の全レコードが一度にメモリ上に展開される</li><li>返却されたListは検索後も保持され続ける</li><li>大量データの検索では OutOfMemoryError のリスクがある</li></ul><p><strong>適している場面:</strong></p><ul><li>検索結果が少量(〜100件程度)の場合</li><li>検索結果を複数回参照する必要がある場合</li><li>検索結果をソートや加工してから利用する場合</li></ul><h3 id="stream-メソッドの特徴" tabindex="-1">stream()メソッドの特徴 <a class="header-anchor" href="#stream-メソッドの特徴" aria-label="Permalink to &quot;stream()メソッドの特徴&quot;">​</a></h3><p><code>stream()</code> メソッドは、検索結果を <strong>1件ずつ逐次的に処理するStream形式で返却</strong> します。</p><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 検索結果を1件ずつストリーム処理</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">agent.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">query</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Product.class)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">stream</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">forEach</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(product </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> processProduct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(product)); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 1件ずつ処理</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><strong>メモリ使用の特徴:</strong></p><ul><li>検索結果を1件ずつメモリに読み込み、処理後は破棄される</li><li>常に処理中の1件分のメモリしか使用しない</li><li>大量データでも安定したメモリ使用量を維持できる</li></ul><p><strong>適している場面:</strong></p><ul><li>検索結果が大量(100件以上)の場合</li><li>検索結果を1回だけ順次処理する場合</li><li>メモリ使用量を抑制したい場合</li></ul><h3 id="メモリ効率の比較" tabindex="-1">メモリ効率の比較 <a class="header-anchor" href="#メモリ効率の比較" aria-label="Permalink to &quot;メモリ効率の比較&quot;">​</a></h3><p>10万件のデータを処理する場合の違いを例に説明します。</p><p><strong>collect()を使用した場合:</strong></p><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 10万件すべてがメモリに読み込まれる</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">List&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Product</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; products </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> agent.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">query</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Product.class)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">collect</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// メモリ: 10万件分のオブジェクト</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 処理中もリスト全体がメモリに残る</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (Product product </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> products) {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    processProduct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(product);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 処理後もGCされるまでメモリに残る</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p><strong>stream()を使用した場合:</strong></p><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 1件ずつ処理され、処理後は解放される</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">agent.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">query</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Product.class)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">stream</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">forEach</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(product </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> processProduct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(product));  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// メモリ: 常に1件分のみ</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 処理完了後は自動的に解放される</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="推奨事項" tabindex="-1">推奨事項 <a class="header-anchor" href="#推奨事項" aria-label="Permalink to &quot;推奨事項&quot;">​</a></h3><ul><li><strong>小〜中規模のデータ(〜100件)</strong>: <code>collect()</code> を使用して可読性とシンプルさを優先</li><li><strong>大規模データ(100件以上)</strong>: <code>stream()</code> を使用してメモリ効率を優先</li><li><strong>件数が不明な場合</strong>: <code>stream()</code> を使用して安全性を優先</li></ul><p>特に大量データを扱うバッチ処理では、<code>stream()</code> の使用が必須となります。</p><h2 id="_2-select-insertやselect-updateの実装方式の違い" tabindex="-1">2. SELECT-INSERTやSELECT-UPDATEの実装方式の違い <a class="header-anchor" href="#_2-select-insertやselect-updateの実装方式の違い" aria-label="Permalink to &quot;2. SELECT-INSERTやSELECT-UPDATEの実装方式の違い&quot;">​</a></h2><p>SELECT-INSERTやSELECT-UPDATEは、あるテーブルから取得したデータを別のテーブルに挿入または更新する処理です。<br><strong>uroboroSQL</strong> では以下の3つの実装方式があり、それぞれパフォーマンス特性が異なります。<br> （以下ではSELECT-INSERTを例に解説します）</p><h3 id="方式1-sqlによるselect-insert-最も高速" tabindex="-1">方式1: SQLによるSELECT-INSERT（最も高速） <a class="header-anchor" href="#方式1-sqlによるselect-insert-最も高速" aria-label="Permalink to &quot;方式1: SQLによるSELECT-INSERT（最も高速）&quot;">​</a></h3><p>データベースエンジン内で完結するため、最も高速に処理できます。</p><div class="language-sql vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- sample/insert_target_tables.sql</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">insert</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">into</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	target_table</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	col1</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,	col2</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,	col3</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">select</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	col1	</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	col1</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,	col2	</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	col2</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,	col3	</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	col3</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	source_table	st</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">where</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">	st</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">condition</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	=</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	/*condition*/</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;&#39;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// SQL内でSELECTとINSERTを同時に実行</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> agent.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">update</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;sample/insert_target_tables&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">param</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;condition&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, conditionValue)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">count</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><strong>特徴:</strong></p><ul><li>データベース内で処理が完結し、ネットワーク転送が不要</li><li>トランザクション管理がシンプル</li><li>大量データでも高速に処理可能</li><li>Javaアプリケーション側でのデータ加工ができない</li></ul><p><strong>パフォーマンス:</strong> ★★★★★（最速）</p><p><strong>適している場面:</strong></p><ul><li>データの加工が不要な単純なコピー処理</li><li>大量データ（数万件以上）の一括転送</li><li>データベース間の同期処理</li></ul><h3 id="方式2-バッチ処理によるselect-insert-推奨" tabindex="-1">方式2: バッチ処理によるSELECT-INSERT（推奨） <a class="header-anchor" href="#方式2-バッチ処理によるselect-insert-推奨" aria-label="Permalink to &quot;方式2: バッチ処理によるSELECT-INSERT（推奨）&quot;">​</a></h3><p>検索結果をバッチでまとめてINSERTします。データ加工とパフォーマンスのバランスが良い方式です。</p><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// SELECTした結果をバッチINSERT</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">agent.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">inserts</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(agent.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">query</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(SourceEntity.class) </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 検索結果のStreamをTargetEntityに変換しながらバッチインサートのパラメータとして渡す</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">stream</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">map</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(sourceEntity </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // データ加工が可能</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        TargetEntity targetEntity </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> TargetEntity</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        targetEntity.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setCol1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(sourceEntity.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getCol1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        targetEntity.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setCol2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">transform</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(sourceEntity.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getCol2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">())); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 加工処理</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        targetEntity.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setCol3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(sourceEntity.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getCol3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> targetEntity;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }));</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><strong>特徴:</strong></p><ul><li>Javaコード内でデータ加工が可能</li><li>バッチサイズ単位でまとめてINSERTされる（デフォルト1,000件）</li><li><code>stream()</code> を使用することでメモリ効率が良い</li><li>ネットワーク転送は発生するが、バッチ化により最小化</li></ul><p><strong>パフォーマンス:</strong> ★★★★☆（高速）</p><p><strong>適している場面:</strong></p><ul><li>データの加工や変換が必要な場合</li><li>ビジネスロジックを適用する必要がある場合</li><li>中〜大規模データ（数千〜数十万件）の処理</li></ul><h3 id="方式3-forループによる1件ずつinsert-非推奨" tabindex="-1">方式3: forループによる1件ずつINSERT（非推奨） <a class="header-anchor" href="#方式3-forループによる1件ずつinsert-非推奨" aria-label="Permalink to &quot;方式3: forループによる1件ずつINSERT（非推奨）&quot;">​</a></h3><p>検索結果を1件ずつ個別にINSERTします。最も遅い方式です。</p><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// SELECTした結果を1件ずつINSERT</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">agent.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">query</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(SourceEntity.class)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">stream</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">forEach</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(sourceEntity </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // データ加工が可能</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        TargetEntity target </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> TargetEntity</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        target.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setCol1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(sourceEntity.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getCol1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        target.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setCol2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">transform</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(sourceEntity.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getCol2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">())); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 加工処理</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        target.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setCol3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(sourceEntity.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getCol3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        agent.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">insert</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(target);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    });</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><strong>特徴:</strong></p><ul><li>1件ごとにSQL実行とネットワーク転送が発生</li><li>データベースへの負荷が高い</li><li>トランザクション処理のオーバーヘッドが大きい</li><li><code>collect()</code> を使用する場合はメモリ使用量も大きい</li></ul><p><strong>パフォーマンス:</strong> ★☆☆☆☆（低速）</p><p><strong>適している場面:</strong></p><ul><li>ほぼ適している場面はない（レガシーコードの互換性維持など特殊な場合のみ）</li></ul><h3 id="パフォーマンス比較" tabindex="-1">パフォーマンス比較 <a class="header-anchor" href="#パフォーマンス比較" aria-label="Permalink to &quot;パフォーマンス比較&quot;">​</a></h3><p>10万件のデータをSELECT-INSERTする場合の目安:</p><table tabindex="0"><thead><tr><th>方式</th><th>処理時間の目安</th><th>ネットワーク転送</th><th>メモリ使用量</th></tr></thead><tbody><tr><td>方式1: SQL内SELECT-INSERT</td><td>1-2秒</td><td>なし</td><td>最小</td></tr><tr><td>方式2: バッチ処理</td><td>5-10秒</td><td>バッチ単位で発生（バッチサイズ:1,000の場合、100回）</td><td>小（streamの場合）</td></tr><tr><td>方式3: 1件ずつINSERT</td><td>数分〜</td><td>10万回発生</td><td>大（collectの場合）</td></tr></tbody></table><h3 id="推奨事項-1" tabindex="-1">推奨事項 <a class="header-anchor" href="#推奨事項-1" aria-label="Permalink to &quot;推奨事項&quot;">​</a></h3><ul><li><strong>データ加工が不要な場合</strong>: 方式1（SQL内SELECT-INSERT）を使用</li><li><strong>データ加工が必要な場合</strong>: 方式2（バッチ処理）を使用</li><li><strong>方式3は原則使用しない</strong>: パフォーマンスが著しく低下するため避ける</li></ul><p>特に大量データを扱う場合は、方式1または方式2を選択し、必ず <code>stream()</code> を使用してメモリ効率を確保してください。</p><h2 id="_3-バッチ処理とバルク処理の違い" tabindex="-1">3. バッチ処理とバルク処理の違い <a class="header-anchor" href="#_3-バッチ処理とバルク処理の違い" aria-label="Permalink to &quot;3. バッチ処理とバルク処理の違い&quot;">​</a></h2><p><strong>uroboroSQL</strong> では、複数件のデータを効率的に登録・更新する方法として <strong>バッチ処理</strong> と <strong>バルク処理</strong> の2つが提供されています。<br> これらは似ているように見えますが、内部動作とパフォーマンス特性が大きく異なります。</p><h3 id="バッチ処理の特徴" tabindex="-1">バッチ処理の特徴 <a class="header-anchor" href="#バッチ処理の特徴" aria-label="Permalink to &quot;バッチ処理の特徴&quot;">​</a></h3><p>バッチ処理は、JDBC の <code>PreparedStatement.addBatch()</code> や <code>PreparedStatement.executeBatch()</code> を使用して、<strong>更新コマンドと複数のパラメータ値のセットをまとめてデータベースに送信</strong> する方式です。</p><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// バッチINSERT（DAO API）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Stream&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Employee</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; employees </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> agent.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">query</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Employee.class).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">stream</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">agent.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">inserts</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(employees);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// バッチINSERT（SQLファイル API）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Stream&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Product</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; products </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> agent.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">query</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Product.class).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">stream</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">agent.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">batch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;example/insert_product&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">paramStream</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(products)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">count</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p><strong>内部動作:</strong></p><ol><li>PreparedStatementを1つ作成</li><li>パラメータをバインドして <code>addBatch()</code> でバッファに追加</li><li>バッチサイズ（デフォルト1,000件）に達したら <code>executeBatch()</code> で一括実行</li><li>全データ処理が完了するまで繰り返し</li></ol><p><strong>特徴:</strong></p><ul><li>データベースへの送信回数が大幅に削減される</li><li>ネットワークオーバーヘッドが最小化される</li><li>大量データ（数千〜数十万件）の処理に適している</li><li>メモリ使用量が安定している</li></ul><p><strong>パフォーマンス:</strong> ★★★★★（大量データで高速）</p><h3 id="バルク処理の特徴" tabindex="-1">バルク処理の特徴 <a class="header-anchor" href="#バルク処理の特徴" aria-label="Permalink to &quot;バルク処理の特徴&quot;">​</a></h3><p>バルク処理は、<strong>1つのINSERT文で複数行を同時に登録</strong> する方式です。</p><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// バルクINSERT（DAO API）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Stream&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Employee</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; employees </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> agent.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">query</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Employee.class).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">stream</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">agent.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">inserts</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(employees, InsertsType.BULK);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>生成されるSQL:</p><div class="language-sql vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">insert</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">into</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    employee</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    col1</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,   col2</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,   col3</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">values</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    (?, ?, ?)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,   (?, ?, ?)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,   (?, ?, ?)  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 3行分を1つのINSERT文で</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><strong>内部動作:</strong></p><ol><li>複数件のデータを登録するINSERT文を生成（デフォルト10件ずつ）</li><li>単一のSQL文として実行</li><li>全データ処理が完了するまで繰り返し</li></ol><p><strong>特徴:</strong></p><ul><li>1回のSQL実行で複数件のデータを登録</li><li><strong>一度に登録するデータ件数を増やすとSQL文が巨大化し、SQL文の生成コストも増加する</strong></li><li>データベースによってはSQL文の長さ制限に抵触する可能性がある</li><li>パース時間やメモリ消費が増加する</li><li>DBの種類によってはバルクINSERTに対応していない場合がある（例: Oracle21c まで）</li></ul><p><strong>パフォーマンス:</strong> ★★★☆☆（少量データでは高速、大量データでは不適）</p><h3 id="バッチ処理とバルク処理の使い分け" tabindex="-1">バッチ処理とバルク処理の使い分け <a class="header-anchor" href="#バッチ処理とバルク処理の使い分け" aria-label="Permalink to &quot;バッチ処理とバルク処理の使い分け&quot;">​</a></h3><table tabindex="0"><thead><tr><th>項目</th><th>バッチ処理</th><th>バルク処理</th></tr></thead><tbody><tr><td>適切なデータ件数</td><td>数百件〜</td><td><strong>数十件まで</strong></td></tr><tr><td>SQL実行回数</td><td>バッチサイズ単位（例: 1,000件ごと）</td><td>バッチサイズ単位（例: 10件ごと）</td></tr><tr><td>メモリ使用量</td><td>安定</td><td>データ量に比例して増加</td></tr><tr><td>SQL文のサイズ</td><td>固定</td><td>データ量に比例して増加</td></tr><tr><td>ネットワーク転送量</td><td>最小</td><td>少量</td></tr></tbody></table><h3 id="推奨事項-2" tabindex="-1">推奨事項 <a class="header-anchor" href="#推奨事項-2" aria-label="Permalink to &quot;推奨事項&quot;">​</a></h3><ul><li><strong>原則バッチ処理を使用</strong></li><li>処理時間の高速化が必要で、計測によりバッチ処理よりもバルク処理のほうが早く、かつ、メモリやCPU使用量の増加を許容できる場合のみバルク処理を採用する</li></ul><div class="danger custom-block"><p class="custom-block-title"><strong>重要な注意点</strong></p><p>バルク処理は便利ですが、<strong>データ件数が数十件を超える場合は使用しないでください</strong><br> SQL文が巨大化することで以下の問題が発生する可能性があります:</p><ul><li>データベースのSQL文長制限に抵触（例: MySQLの <code>max_allowed_packet</code> 制限）</li><li>パース時間の増加によるパフォーマンス低下</li><li>メモリ使用量の急増</li><li>ネットワーク転送時のタイムアウト</li></ul><p>大量データの処理では、必ずバッチ処理を選択してください。</p></div><h2 id="_4-バッチ件数による性能の違い" tabindex="-1">4. バッチ件数による性能の違い <a class="header-anchor" href="#_4-バッチ件数による性能の違い" aria-label="Permalink to &quot;4. バッチ件数による性能の違い&quot;">​</a></h2><p>バッチ処理やバルク処理では、実行時にインサート条件としてバッチサイズを指定することで何件ごとにデータベースへ送信するかを制御できます。このバッチサイズの設定値によって処理性能が大きく変わります。</p><h3 id="バッチサイズの指定方法" tabindex="-1">バッチサイズの指定方法 <a class="header-anchor" href="#バッチサイズの指定方法" aria-label="Permalink to &quot;バッチサイズの指定方法&quot;">​</a></h3><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// DAO APIの場合</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// バッチサイズを指定（デフォルトは1,000件）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">agent.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">inserts</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(employees, (ctx, count, row) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 500</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 500件ごとに送信するようInsertConditionを指定</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// SQLファイル APIの場合</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">agent.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">batch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;example/insert_product&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">paramStream</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(products)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">by</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((ctx, row) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">batchCount</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 500</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 500件ごとに送信</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">count</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="バッチサイズによる性能の違い" tabindex="-1">バッチサイズによる性能の違い <a class="header-anchor" href="#バッチサイズによる性能の違い" aria-label="Permalink to &quot;バッチサイズによる性能の違い&quot;">​</a></h3><p>バッチサイズが小さすぎる場合と大きすぎる場合、それぞれ異なる問題が発生します。</p><p><strong>バッチサイズが小さい場合（例: 10件）:</strong></p><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 10件ごとに送信</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">agent.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">inserts</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(employees, (ctx, count, row) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ul><li>データベースへの送信回数が増加</li><li>ネットワークオーバーヘッドが大きくなる</li><li>全体の処理時間が増加</li></ul><p><strong>バッチサイズが大きい場合（例: 10,000件）:</strong></p><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 10,000件ごとに送信</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">agent.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">inserts</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(employees, (ctx, count, row) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 10000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ul><li>1回の送信データ量が増加</li><li>PreparedStatementにバインドパラメータを格納するバッファの格納量が増えることでメモリ使用量が増加</li><li>データベースのバッファサイズを超える可能性</li><li>ネットワークタイムアウトのリスク増加</li></ul><h3 id="最適なバッチサイズ" tabindex="-1">最適なバッチサイズ <a class="header-anchor" href="#最適なバッチサイズ" aria-label="Permalink to &quot;最適なバッチサイズ&quot;">​</a></h3><p>10万件のデータをINSERTする場合の処理時間の目安<br><strong>（DBの性能やネットワーク環境により大きく変わるため、あくまで目安として参照してください）</strong></p><table tabindex="0"><thead><tr><th style="text-align:right;">バッチサイズ</th><th>処理時間の目安</th><th style="text-align:right;">データベース送信回数</th><th>特徴</th></tr></thead><tbody><tr><td style="text-align:right;">10件</td><td>30-40秒</td><td style="text-align:right;">10,000回</td><td>送信回数が多すぎて非効率</td></tr><tr><td style="text-align:right;">100件</td><td>12-15秒</td><td style="text-align:right;">1,000回</td><td>やや送信回数が多い</td></tr><tr><td style="text-align:right;">1,000件</td><td>5-10秒</td><td style="text-align:right;">100回</td><td><strong>バランスが良い（推奨）</strong></td></tr><tr><td style="text-align:right;">5,000件</td><td>6-12秒</td><td style="text-align:right;">20回</td><td>メモリ使用量増加、効果は限定的</td></tr><tr><td style="text-align:right;">10,000件</td><td>7-15秒</td><td style="text-align:right;">10回</td><td>メモリ使用量大、リスク増加</td></tr></tbody></table><h3 id="推奨事項-3" tabindex="-1">推奨事項 <a class="header-anchor" href="#推奨事項-3" aria-label="Permalink to &quot;推奨事項&quot;">​</a></h3><ul><li><strong>デフォルト値（1,000件）を使用</strong>: ほとんどのケースで最適なパフォーマンスを発揮</li><li><strong>特殊な要件がある場合のみ調整</strong>: <ul><li>メモリが非常に限られている環境: 500件程度に削減</li><li>高速ネットワーク環境で超大量データ: 2,000-5,000件に増加</li></ul></li></ul><div class="danger custom-block"><p class="custom-block-title"><strong>調整する場合は必ず計測する</strong></p><p>バッチ処理やバルク処理の処理時間は環境によって最適値が異なるため、<strong>必ず</strong>実測して効果を確認したうえで変更すること</p></div>`,103))])}const m=n(k,[["render",d]]);export{b as __pageData,m as default};
