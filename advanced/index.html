<!DOCTYPE html>
<html lang="ja">

<!-- Head tag -->
<head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!--Description-->
    
        <meta name="description" content="uroboroSQLの公式ドキュメントサイトです。">
    

    <!--Author-->
    
        <meta name="author" content="Future Architect">
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="高度な操作">
    

    <!--Open Graph Site Name-->
    <meta property="og:site_name" content="uroboroSQL ドキュメント">

    <!--Page Cover-->
    
        <meta property="og:image" content="/uroborosql-doc/images/logo.png">
    

    <!-- Title -->
    
    <title>高度な操作 - uroboroSQL ドキュメント</title>

    <!-- Custom CSS -->
    <!-- <link rel="stylesheet" href="/css/main.css"> -->
    <link rel="stylesheet" href="/uroborosql-doc/css/main.css">

    <!--[if lt IE 8]>
        <script src="/uroborosql-doc/js/ie/html5shiv.js"></script>
    <![endif]-->

    <!--[if lt IE 8]>
        <link rel="stylesheet" href="/uroborosql-doc/sass/ie8.css">
    <![endif]-->

    <!--[if lt IE 9]>
        <link rel="stylesheet" href="/uroborosql-doc/sass/ie9.css">
    <![endif]-->

    <!-- Gallery -->
    <link href="//cdn.rawgit.com/noelboss/featherlight/1.3.5/release/featherlight.min.css" type="text/css" rel="stylesheet">
    <link rel="shortcut icon" href="/uroborosql-doc/favicon.ico">

    <script async defer src="https://buttons.github.io/buttons.js"></script>
    <script src="https://apis.google.com/js/platform.js" async defer>
      {lang: 'ja'}
    </script>
    <!-- Google Analytics -->
    
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-93486523-1', 'auto');
        ga('send', 'pageview');

    </script>



</head>


<body>

    <div id="wrapper">

        <!-- Menu -->
        <!-- Header -->
<header id="header">
    <div class="inner">
        <!-- Logo -->
        <a href="/uroborosql-doc/" class="logo">
            <span class="symbol"><img src="/uroborosql-doc//images/logo.png" alt=""></span>
        </a>
        <!-- Nav -->
        <nav>
            <ul>
                <li><a href="#menu">Menu</a></li>
            </ul>
        </nav>
    </div>
</header>
<!-- Menu -->
<nav id="menu">
    <h2>Menu</h2>
    <form id="search-form">
        <input type="text" id="local-search-input" name="q" results="0" placeholder="search..." class="search form-control" autocomplete="off" autocorrect="off">
        <i class="fa fa-times" onclick="resetSearch()"></i>
    </form>
    <div id="local-search-result"></div>
    <p class="no-result">No results found</p>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js"></script>
    <script src="/uroborosql-doc/js/search.js"></script>
    <script>
    var path = "/uroborosql-doc//search.xml";
    searchFunc(path, 'local-search-input', 'local-search-result');
    </script>
    <ul id="menu-agenda">
        <li><a href="/uroborosql-doc/why_uroborosql/">Why uroboroSQL?</a></li>
        <li><a href="/uroborosql-doc/getting_started/">Getting Started</a></li>
        <li><a href="/uroborosql-doc/basics/">基本操作</a></li>
        <li><a href="/uroborosql-doc/advanced/">高度な操作</a></li>
        <li><a href="/uroborosql-doc/developer_guide/">開発者ガイド</a></li>
        <li><a href="/uroborosql-doc/license/">License</a></li>
        <li><a href="/uroborosql-doc/about_uroborosql/">uroboroSQLについて</a></li>
    </ul>
</nav>

        <div id="main">
            <div class="inner">

                <!-- Main Content -->
                

    <h1>高度な操作</h1>



<!-- Gallery -->


<!-- Content -->
<hr>
<ul>
<li><a href="#SqlConfigのカスタマイズ">SqlConfigのカスタマイズ</a><ul>
<li><a href="#区分値定数や列挙型の利用">区分値定数や列挙型の利用</a></li>
<li><a href="#SQLフィルター">SQLフィルター</a></li>
<li><a href="#SQLファイルルートフォルダの設定">SQLファイルルートフォルダの設定</a></li>
<li><a href="#エラーハンドリング">エラーハンドリング</a></li>
<li><a href="#SQL発行のリトライ">SQL発行のリトライ</a></li>
<li><a href="#SqlAgentの挙動設定">SqlAgentの挙動設定</a></li>
<li><a href="#自動パラメータバインド関数の設定">自動パラメータバインド関数の設定</a></li>
</ul>
</li>
<li><a href="#SQLカバレッジ">SQLカバレッジ</a></li>
<li><a href="#ログ">ログ</a></li>
<li><a href="#システムプロパティ">システムプロパティ</a></li>
</ul>
<hr>
<h2 id="SqlConfigのカスタマイズ"><a href="#SqlConfigのカスタマイズ" class="headerlink" title="SqlConfigのカスタマイズ"></a>SqlConfigのカスタマイズ</h2><p>uroboroSQLではSqlConfigを生成するタイミングで各種の設定を行うことによりSQL発行時の動作を変更することができます。<br>設定は<code>UroboroSQL</code>ビルダーAPIで行います。</p>
<h3 id="区分値定数や列挙型の利用"><a href="#区分値定数や列挙型の利用" class="headerlink" title="区分値定数や列挙型の利用"></a>区分値定数や列挙型の利用</h3><p>これまでSQLの開発では、区分値や定数値などの固定値がマジックナンバーとしてSQL文内に埋め込まれていました。<br>しかしマジックナンバーの記述は可読性が悪く仕様変更時の影響調査が困難なため不具合の温床となっていました。</p>
<p>例</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line"> *</span><br><span class="line"><span class="keyword">FROM</span> EMPLOYEE</span><br><span class="line"><span class="keyword">WHERE</span> EMP_TYP = <span class="string">'05'</span> <span class="comment">-- 05:従業員     &lt;-- 従業員の区分が変わったらどうする？</span></span><br></pre></td></tr></table></figure>
<p>uroboroSQLはエンタープライズ分野での開発に利用されてきた経験から、SQL文の中でマジックナンバーの代わりに定数や列挙型を利用するための仕組みを提供しています。</p>
<p>区分値定数/列挙型を利用するためには<code>SqlConfig</code>に以下の設定を追加します。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// create SqlConfig</span></span><br><span class="line">SqlConfig config = UroboroSQL</span><br><span class="line">  .builder(...)</span><br><span class="line">  <span class="comment">// SqlContextFactoryの設定</span></span><br><span class="line">  .setSqlContextFactory(<span class="keyword">new</span> SqlContextFactoryImpl()</span><br><span class="line">    <span class="comment">// 定数クラス設定の追加</span></span><br><span class="line">    .setConstantClassNames(Arrays.asList(TypeConstants.class.getName()))</span><br><span class="line">    <span class="comment">// 列挙型パッケージ設定の追加</span></span><br><span class="line">    .setEnumConstantPackageNames(Arrays.asList(Gender.class.getPackage().getName()))</span><br><span class="line">     <span class="comment">// 定数パラメータのプレフィックス指定(初期値 : CLS_)</span></span><br><span class="line">    .setConstParamPrefix(<span class="string">"CLS_"</span>))</span><br><span class="line">  .build();</span><br></pre></td></tr></table></figure></p>
<p>定数クラス : TypeConstants.javaの実装例<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 区分値定数クラス</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">TypeConstants</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="title">TypeConstants</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** 区分種別名称：口座種別区分  区分種別番号：0035  長さ：0 */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ACCOUNT_TYP = <span class="string">"0035"</span>;</span><br><span class="line">  <span class="comment">/** 区分種別名称：口座種別区分  区分値名称：普通  区分値略称：普通  区分値番号：1 */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ACCOUNT_TYP_FUTSU = <span class="string">"1"</span>;</span><br><span class="line">  <span class="comment">/** 区分種別名称：口座種別区分  区分値名称：当座  区分値略称：当座  区分値番号：2 */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ACCOUNT_TYP_TOUZA = <span class="string">"2"</span>;</span><br><span class="line">  <span class="comment">/** 区分種別名称：口座種別区分  区分値名称：定期  区分値略称：定期  区分値番号：3 */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ACCOUNT_TYP_TEIKI = <span class="string">"3"</span>;</span><br><span class="line">  <span class="comment">/** 区分種別名称：発行区分  区分種別番号：0052  長さ：0 */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ISSUE_TYP = <span class="string">"0052"</span>;</span><br><span class="line">  <span class="comment">/** 区分種別名称：発行区分  区分値名称：未発行  区分値略称：未発行  区分値番号：1 */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ISSUE_TYP_UNISSUED = <span class="string">"1"</span>;</span><br><span class="line">  <span class="comment">/** 区分種別名称：発行区分  区分値名称：発行済  区分値略称：発行済  区分値番号：2 */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ISSUE_TYP_OUTSTANDING = <span class="string">"2"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * システム定数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Consts</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="title">Consts</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">CommonValue</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">CommonValue</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 業務日付（オンライン） */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ONLINE_YMD = <span class="string">"1"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 業務日付（バッチ） */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String BATCH_YMD = <span class="string">"2"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** SQL上でのフラグ表現（TRUE=1） */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String FLAG_ON = <span class="string">"1"</span>;</span><br><span class="line">    <span class="comment">/** SQL上でのフラグ表現（FALSE=0） */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String FLAG_OFF = <span class="string">"0"</span>;</span><br><span class="line">    <span class="comment">/** 日付ALL0 */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ZERO_DATE = <span class="string">"00000000"</span>;</span><br><span class="line">    <span class="comment">/** 日付最小値 */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String MIN_DATE = <span class="string">"19000101"</span>;</span><br><span class="line">    <span class="comment">/** 日付最大値 */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String MAX_DATE = <span class="string">"99991231"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>列挙型 : Gender.javaの実装例<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 性別を表す列挙型</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> Gender &#123;</span><br><span class="line">  MALE(<span class="string">"M"</span>), FEMALE(<span class="string">"F"</span>), OTHER(<span class="string">"O"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> String label;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="title">Gender</span><span class="params">(String label)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.label = label;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> label;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>このように区分値定数や列挙型を定数パラメータとして登録しておくことで、SQL文の中で定数名が利用できるようになります。</p>
<p>定数パラメータを利用する場合、以下の命名ルールに従ってパラメータを指定します。</p>
<table>
<thead>
<tr>
<th style="text-align:left">パターン</th>
<th style="text-align:left">書式</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">定数</td>
<td style="text-align:left">[定数パラメータプレフィックス][定数フィールド名大文字]</td>
</tr>
<tr>
<td style="text-align:left">定数(Innerクラスがある場合)</td>
<td style="text-align:left">[定数パラメータプレフィックス][Innerクラス名大文字スネークケース]_[Innerクラス内定数フィールド名大文字]</td>
</tr>
<tr>
<td style="text-align:left">列挙型</td>
<td style="text-align:left">[定数パラメータプレフィックス][列挙型名大文字]_[列挙子名大文字]</td>
</tr>
</tbody>
</table>
<blockquote>
<p>※定数パラメータプレフィックスの初期値は <code>CLS_</code>となっています。SqlConfig生成時の設定で変更することが可能です。</p>
</blockquote>
<p>実際に使用する際は置換文字列として</p>
<ul>
<li>/*#[定数パラメータプレフィックス][定数フィールド名大文字]*/</li>
<li>/*#[定数パラメータプレフィックス][Innerクラス名大文字スネークケース]_[Innerクラス内定数フィールド名大文字]*/</li>
<li>/*#[定数パラメータプレフィックス][列挙型名大文字]_[列挙子名大文字]*/ </li>
</ul>
<p>または</p>
<ul>
<li>/*$[定数パラメータプレフィックス][定数フィールド名大文字]*/</li>
<li>/*$[定数パラメータプレフィックス][Innerクラス名大文字スネークケース]_[Innerクラス内定数フィールド名大文字]*/</li>
<li>/*$[定数パラメータプレフィックス][列挙型名大文字]_[列挙子名大文字]*/ </li>
</ul>
<p>という風に使用します。  </p>
<blockquote>
<p>定数や列挙型の値は固定なので生成されるSQLは毎回同じ値になり、SQL文解析処理によるCPU負荷を考慮する必要はありません。</p>
</blockquote>
<p>定数の例<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">  EMP.EMP_NO    <span class="keyword">AS</span>  EMP_NO</span><br><span class="line">,  EMP.FIRST_NAME  <span class="keyword">AS</span>  FIRST_NAME</span><br><span class="line">,  EMP.LAST_NAME  <span class="keyword">AS</span>  LAST_NAME</span><br><span class="line">,  EMP.BIRTH_DATE  <span class="keyword">AS</span>  BIRTH_DATE</span><br><span class="line">,  EMP.GENDER    <span class="keyword">AS</span>  GENDER</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">  EMPLOYEE  EMP</span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">  EMP.BIRTH_DATE    !=  <span class="comment">/*#CLS_COMMON_VALUE_ZERO_DATE*/</span><span class="string">'00000000'</span>  <span class="comment">-- 定数パラメータの指定</span></span><br></pre></td></tr></table></figure></p>
<p>列挙型の例<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">  EMP.EMP_NO    <span class="keyword">AS</span>  EMP_NO</span><br><span class="line">,  EMP.FIRST_NAME  <span class="keyword">AS</span>  FIRST_NAME</span><br><span class="line">,  EMP.LAST_NAME  <span class="keyword">AS</span>  LAST_NAME</span><br><span class="line">,  EMP.BIRTH_DATE  <span class="keyword">AS</span>  BIRTH_DATE</span><br><span class="line">,  EMP.GENDER    <span class="keyword">AS</span>  GENDER</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">  EMPLOYEE  EMP</span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">  EMP.GENDER    =  <span class="comment">/*#CLS_GENDER_FEMALE*/</span><span class="string">'F'</span>  <span class="comment">-- 列挙型定数パラメータの指定</span></span><br></pre></td></tr></table></figure></p>
<h3 id="SQLフィルター"><a href="#SQLフィルター" class="headerlink" title="SQLフィルター"></a>SQLフィルター</h3><p>uroboroSQLではSQLの実行を行う一連の処理の流れの中にいくつかの拡張ポイントを設けており、この拡張ポイントに処理を追加することで、共通的なSQL文の加工や検索結果の記録といった様々な拡張を行うことができるように設計されています。</p>
<p>SQL処理の拡張はSqlFilterインタフェースを実装したクラスを作成し登録することで行います。<br>SqlFilterインタフェースには以下のメソッドが定義されています。</p>
<table>
<thead>
<tr>
<th style="text-align:left">SqlFilterメソッド名</th>
<th style="text-align:left">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">initialize</td>
<td style="text-align:left">SqlFilterの初期化を行う</td>
</tr>
<tr>
<td style="text-align:left">doTransformSql</td>
<td style="text-align:left">変換前のSQLに対して加工を行う</td>
</tr>
<tr>
<td style="text-align:left">doParameter</td>
<td style="text-align:left">バインドパラメータの加工を行う</td>
</tr>
<tr>
<td style="text-align:left">doOutParameter</td>
<td style="text-align:left">ストアドプロシージャのOutParameterの加工を行う</td>
</tr>
<tr>
<td style="text-align:left">doPreparedStatement</td>
<td style="text-align:left">PreparedStatementの加工を行う</td>
</tr>
<tr>
<td style="text-align:left">doCallableStatement</td>
<td style="text-align:left">CallableStatementの加工を行う</td>
</tr>
<tr>
<td style="text-align:left">doQuery</td>
<td style="text-align:left">検索処理結果の加工を行う</td>
</tr>
<tr>
<td style="text-align:left">doUpdate</td>
<td style="text-align:left">更新処理結果の加工を行う</td>
</tr>
<tr>
<td style="text-align:left">doBatch</td>
<td style="text-align:left">バッチ処理結果の加工を行う</td>
</tr>
<tr>
<td style="text-align:left">doProcedure</td>
<td style="text-align:left">Procedure呼出処理結果の加工を行う</td>
</tr>
</tbody>
</table>
<p>uroboroSQLには標準でいくつかのSqlFilterの実装が含まれています。</p>
<table>
<thead>
<tr>
<th style="text-align:left">クラス名</th>
<th style="text-align:left">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">jp.co.future.uroborosql.filter.DebugSqlFilter</td>
<td style="text-align:left">SqlFilterの動作を理解するためのサンプル。<br>各拡張ポイントで呼び出されるメソッドでログを出力します。</td>
</tr>
<tr>
<td style="text-align:left">jp.co.future.uroborosql.filter.DumpResultSqlFilter</td>
<td style="text-align:left">検索結果を表形式でログ出力するSQLフィルター。<br>SqlREPLで使用しています。</td>
</tr>
<tr>
<td style="text-align:left">jp.co.future.uroborosql.filter.WrapContextSqlFilter</td>
<td style="text-align:left">SQL文の前後に文字列を追加するSQLフィルター。<br>ページングや検索件数の上限設定に使用します。</td>
</tr>
<tr>
<td style="text-align:left">jp.co.future.uroborosql.filter.SecretColumnSqlFilter</td>
<td style="text-align:left">指定した特定のカラムのみ暗号化を行うSQLフィルター。<br>パスワードや機密情報を暗号化してDBに格納するために使用します。</td>
</tr>
<tr>
<td style="text-align:left">jp.co.future.uroborosql.filter.AuditLogSqlFilter</td>
<td style="text-align:left">監査記録を取得するためのSQLフィルター。</td>
</tr>
</tbody>
</table>
<p>SQLフィルターを利用するためには、SqlConfig生成時にSqlFilterManagerの設定を追加して利用するSQLフィルターの登録を行ってください。<br>SQLフィルターは複数登録することができます。複数登録した場合は登録した順にSQLフィルターが処理されます。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// create SqlConfig</span></span><br><span class="line">SqlConfig config = UroboroSQL</span><br><span class="line">  .builder(...)</span><br><span class="line">  <span class="comment">// SqlFilterManagerの設定</span></span><br><span class="line">  .setSqlFilterManager(<span class="keyword">new</span> SqlFilterManagerImpl()</span><br><span class="line">    <span class="comment">// DumpResultSqlFilterの登録</span></span><br><span class="line">    .addSqlFilter(<span class="keyword">new</span> DumpResultSqlFilter())</span><br><span class="line">    <span class="comment">// WrapContextSqlFilterの登録</span></span><br><span class="line">    .addSqlFilter(<span class="keyword">new</span> WrapContextSqlFilter(<span class="string">""</span>,</span><br><span class="line">      <span class="string">"LIMIT /*$maxRowCount*/10 OFFSET /*$startRowIndex*/0"</span>,</span><br><span class="line">      <span class="string">".*FOR\\sUPDATE.*"</span>)))</span><br><span class="line">  .build();</span><br></pre></td></tr></table></figure>
<p>独自にSqlFilterを作成する場合は、<code>jp.co.future.uroborosql.filter.AbstractSqlFilter</code>を継承し、必要に応じてメソッドをオーバーライドしてください。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomSqlFilter</span> <span class="keyword">extends</span> <span class="title">AbstractSqlFilter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 途中略</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResultSet <span class="title">doQuery</span><span class="params">(SqlContext sqlContext, PreparedStatement preparedStatement, ResultSet resultSet)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// フィルター処理の実装</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="SQLファイルルートフォルダの設定"><a href="#SQLファイルルートフォルダの設定" class="headerlink" title="SQLファイルルートフォルダの設定"></a>SQLファイルルートフォルダの設定</h3><p>uroboroSQLは初期設定ではクラスパス上にあるsqlフォルダ配下のSQLを読み込みます。<br>このSQLファイルルートフォルダは変更することができます。</p>
<p>SQLファイルルートフォルダの設定 (custom_sqlフォルダを指定)<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SqlConfig config = UroboroSQL.builder(...)</span><br><span class="line">  <span class="comment">// SQLファイルのルートフォルダの設定(custom_sqlフォルダをルートフォルダにする場合)</span></span><br><span class="line">  .setSqlManager(<span class="keyword">new</span> SqlManagerImpl(<span class="string">"custom_sql"</span>))</span><br><span class="line">  .build();</span><br></pre></td></tr></table></figure></p>
<h3 id="エラーハンドリング"><a href="#エラーハンドリング" class="headerlink" title="エラーハンドリング"></a>エラーハンドリング</h3><p>uroboroSQLからSQLを発行した際にSQLExceptionがスローされると、そのSQLExceptionを内部に保持する<code>UroborosqlSQLException</code>が呼び出し元に返却されます。<br><code>UroborosqlSQLException</code>は<code>java.lang.RuntimeException</code>を継承しているため明示的なキャッチは不要です。</p>
<p>呼出元のアプリケーションで明示的にエラーハンドリングを行う場合は、try-catchでUroborosqlSQLExceptionをキャッチすることで、例外発生時の挙動を制御することができます。</p>
<p>エラーハンドリングの例<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">SqlConfig config = UroboroSQL.builder(...).build();</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> (SqlAgent agent = config.agent()) &#123;</span><br><span class="line">  <span class="comment">// INSERT文の実行</span></span><br><span class="line">  <span class="comment">// insert into product (product_id) values (/*product_id*/0);</span></span><br><span class="line">  agent.update(<span class="string">"example/insert_product"</span>)</span><br><span class="line">    .param(<span class="string">"product_id"</span>, <span class="number">1</span>)</span><br><span class="line">    .count();</span><br><span class="line">&#125; <span class="keyword">catch</span> (UroborosqlSQLException ex) &#123;</span><br><span class="line">  <span class="comment">// SQLExceptionが発生した際に行う処理を実装</span></span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"exception occured. ex="</span> + ex.getCause().getMessage(), ex);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="SQL発行のリトライ"><a href="#SQL発行のリトライ" class="headerlink" title="SQL発行のリトライ"></a>SQL発行のリトライ</h3><p>SQLを発行した際、タイミングによって発生する例外（テーブルロックエラーなど）の場合はリトライを行い、できるだけ正常に処理を終了させたい場合があります。</p>
<p>通常、このようなケースでは以下のような実装を行います。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">SqlConfig config = UroboroSQL.builder(...).build();</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> retryCount = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span>(;;) &#123;</span><br><span class="line">  <span class="keyword">try</span> (SqlAgent agent = config.agent()) &#123;</span><br><span class="line">    <span class="comment">// INSERT文の実行</span></span><br><span class="line">    <span class="comment">// insert into product (product_id) values (/*product_id*/0);</span></span><br><span class="line">    agent.update(<span class="string">"example/insert_product"</span>).param(<span class="string">"product_id"</span>, <span class="number">1</span>).count();</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (UroborosqlSQLException ex) &#123;</span><br><span class="line">    <span class="comment">// SQLExceptionが発生した際に行う処理を実装</span></span><br><span class="line">    <span class="keyword">int</span> errorCode = ex.getErrorCode();</span><br><span class="line">    <span class="keyword">if</span> (errorCode == <span class="number">30006</span> || errorCode == <span class="number">54</span>) &#123;<span class="comment">// リソース・ビジー(Oracleの場合)</span></span><br><span class="line">      <span class="comment">// リトライ対象エラーコードの場合はリトライカウントをカウントアップしてリトライする</span></span><br><span class="line">      retryCount++;</span><br><span class="line">      <span class="keyword">if</span> (retryCount == MAX_RETRY_COUNT) &#123; <span class="comment">// MAX_RETRY_COUNT はアプリケーションで定義された最大リトライ回数の定数とする</span></span><br><span class="line">        <span class="comment">// 最大リトライ回数に達した場合は例外をスローする</span></span><br><span class="line">        <span class="keyword">throw</span> ex;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="comment">// 10ms 待機</span></span><br><span class="line">          Thread.sleep(<span class="number">10</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException iex) &#123;</span><br><span class="line">          <span class="comment">// do nothing</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// リトライ対象エラーコード以外はすぐに例外をスローする</span></span><br><span class="line">      <span class="keyword">throw</span> ex;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>しかし、上記のようなリトライ処理を個々の実装で行うと、実装漏れや実装ミス、実装方法の差異（for()の代わりにwhile()を使用するなど）により、不具合が発生しやすくなります。<br>uroboroSQLでは、アプリケーション全体のリトライ設定と、リトライ全体設定より優先される個別処理でのリトライ用APIの2種類のAPIを提供することで、より簡潔で確実なリトライ処理が行えるよう工夫されています。</p>
<p>アプリケーション全体のリトライ設定はSqlConfig生成時に行います。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">SqlConfig config = UroboroSQL.builder(...)</span><br><span class="line">  <span class="comment">// SqlAgentFactoryの設定</span></span><br><span class="line">  .setSqlAgentFactory(<span class="keyword">new</span> SqlAgentFactoryImpl()</span><br><span class="line">    <span class="comment">// アプリケーション全体のリトライ設定</span></span><br><span class="line">    <span class="comment">// SQLエラーコードが54,30006のいずれか(Oracleのリソース・ビジー)の場合</span></span><br><span class="line">    .setSqlRetryCodeList(Arrays.asList(<span class="string">"54"</span>, <span class="string">"30006"</span>))</span><br><span class="line">    <span class="comment">// 最大リトライ回数（3回）リトライ</span></span><br><span class="line">    .setDefaultMaxRetryCount(<span class="number">3</span>)</span><br><span class="line">    <span class="comment">// リトライ間隔10ms待機</span></span><br><span class="line">    .setDefaultSqlRetryWaitTime(<span class="number">10</span>))</span><br><span class="line">  .build();</span><br></pre></td></tr></table></figure></p>
<p>リトライAPIを用いた実装は次のようになります。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// アプリケーション全体のリトライ設定に従ってリトライを行う。（個別のリトライ指定なし）</span></span><br><span class="line"><span class="keyword">try</span> (SqlAgent agent = config.agent()) &#123;</span><br><span class="line">  <span class="comment">// INSERT文の実行</span></span><br><span class="line">  <span class="comment">// insert into product (product_id) values (/*product_id*/0);</span></span><br><span class="line">  agent.update(<span class="string">"example/insert_product"</span>)</span><br><span class="line">    .param(<span class="string">"product_id"</span>, <span class="number">1</span>)</span><br><span class="line">    .count();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 個別にリトライ設定を上書きする（retry()を利用）</span></span><br><span class="line"><span class="keyword">try</span> (SqlAgent agent = config.agent()) &#123;</span><br><span class="line">  <span class="comment">// INSERT文の実行</span></span><br><span class="line">  <span class="comment">// insert into product (product_id) values (/*product_id*/0);</span></span><br><span class="line">  <span class="comment">// リトライ対象エラーコードの場合、5回のリトライを20ms間隔で行う</span></span><br><span class="line">  agent.update(<span class="string">"example/insert_product"</span>)</span><br><span class="line">    .param(<span class="string">"product_id"</span>, <span class="number">1</span>)</span><br><span class="line">    .retry(<span class="number">5</span>, <span class="number">20</span>)</span><br><span class="line">    .count();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="SqlAgentの挙動設定"><a href="#SqlAgentの挙動設定" class="headerlink" title="SqlAgentの挙動設定"></a>SqlAgentの挙動設定</h3><p>リトライ設定のほかにも、SqlAgentの挙動を変更する設定をSqlConfig生成時に行うことができます。</p>
<table>
<thead>
<tr>
<th style="text-align:left">設定項目</th>
<th style="text-align:left">説明</th>
<th style="text-align:left">初期値</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">fetchSize</td>
<td style="text-align:left">JDBCドライバとDB間のフェッチサイズ(下記補足)</td>
<td style="text-align:left">-1(0以上の値で有効化)</td>
</tr>
<tr>
<td style="text-align:left">queryTimeout</td>
<td style="text-align:left">検索タイムアウト時間(秒)</td>
<td style="text-align:left">-1(0以上の値で有効化)</td>
</tr>
<tr>
<td style="text-align:left">defaultMapKeyCaseFormat</td>
<td style="text-align:left">検索結果のMapキーのデフォルトCaseFormat</td>
<td style="text-align:left">CaseFormat.UPPER_SNAKE_CASE</td>
</tr>
<tr>
<td style="text-align:left">sqlIdKeyName</td>
<td style="text-align:left">SQL_IDを置換するためのKEY文字列</td>
<td style="text-align:left">_SQL_ID_</td>
</tr>
<tr>
<td style="text-align:left">outputExceptionLog</td>
<td style="text-align:left">例外発生時のログ出力を行うかどうかの設定</td>
<td style="text-align:left">false</td>
</tr>
</tbody>
</table>
<ul>
<li>補足<ul>
<li>fetchSizeは、<a href="https://docs.oracle.com/javase/jp/8/docs/api/java/sql/Statement.html#setFetchSize-int-" target="_blank" rel="noopener">Statement.setFetchSize</a>に渡される値です。</li>
<li>collect/foreachメソッドで返却される結果セットの行数を制限する設定ではありません。</li>
</ul>
</li>
</ul>
<p>設定例<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">SqlConfig config = UroboroSQL.builder(...)</span><br><span class="line">  <span class="comment">// SqlAgentFactoryの設定</span></span><br><span class="line">  .setSqlAgentFactory(<span class="keyword">new</span> SqlAgentFactoryImpl()</span><br><span class="line">    <span class="comment">// ドライバ↔DB間のフェッチサイズ設定。初期値 : -1(0以上の値で有効化)</span></span><br><span class="line">    .setFetchSize(<span class="number">1000</span>)</span><br><span class="line">    <span class="comment">// 検索タイムアウト時間(秒)。初期値 : -1(0以上の値で有効化)</span></span><br><span class="line">    .setQueryTimeout(<span class="number">30</span>)</span><br><span class="line">    <span class="comment">// 検索結果のMapキーのデフォルトCaseFormat。初期値 : UPPER_SNAKE_CASE</span></span><br><span class="line">    .setDefaultMapKeyCaseFormat(CaseFormat.CAMEL_CASE)</span><br><span class="line">    <span class="comment">// SQL_IDを置換するためのKEY文字列を設定。初期値 : _SQL_ID_</span></span><br><span class="line">    .setSqlIdKeyName(<span class="string">"_SQL_ID_"</span>)</span><br><span class="line">    <span class="comment">// 例外発生時のログ出力を行うかどうかを設定。初期値 : false</span></span><br><span class="line">    .setOutputExceptionLog(<span class="keyword">true</span>)</span><br><span class="line">  .build();</span><br></pre></td></tr></table></figure></p>
<h3 id="自動パラメータバインド関数の設定"><a href="#自動パラメータバインド関数の設定" class="headerlink" title="自動パラメータバインド関数の設定"></a>自動パラメータバインド関数の設定</h3><p><em>(new v0.6.1)</em></p>
<p>システム内の各テーブルに共通項目（登録日時、更新日時など）が定義されている場合、INSERT文やUPDATE文を発行する際には、必ずこれらの共通項目に対するパラメータを指定する必要が出てきます。<br>このような共通項目へのパラメータ設定を個別の実装で行うと実装が煩雑になりますし、どうしても実装漏れや記述ミスにより正しく値が設定されない、といったことが起こります。</p>
<p>uroboroSQLではこのような共通項目に対して自動でパラメータをバインドする仕組みを提供しています。<br>設定はSqlConfig生成時に行います。</p>
<p>設定例<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">SqlConfig config = UroboroSQL</span><br><span class="line">  .builder(...)</span><br><span class="line">  <span class="comment">// SqlContextFactoryの設定</span></span><br><span class="line">  .setSqlContextFactory(<span class="keyword">new</span> SqlContextFactoryImpl()</span><br><span class="line">    <span class="comment">// query用自動パラメータバインド関数の登録</span></span><br><span class="line">    .addQueryAutoParameterBinder((ctx) -&gt; ctx.paramIfAbsent(<span class="string">"current_flg"</span>, <span class="keyword">true</span>))</span><br><span class="line">    <span class="comment">// update/batch/procedure用自動パラメータバインド関数の登録</span></span><br><span class="line">    .addUpdateAutoParameterBinder((ctx) -&gt; ctx.paramIfAbsent(<span class="string">"ins_datetime"</span>, LocalDateTime.now()))</span><br><span class="line">    .addUpdateAutoParameterBinder((ctx) -&gt; ctx.paramIfAbsent(<span class="string">"upd_datetime"</span>, LocalDateTime.now()))</span><br><span class="line">  )</span><br><span class="line">  .build();</span><br></pre></td></tr></table></figure></p>
<p>自動パラメータバインド関数は<code>SqlContext</code>を引数に受け取るので、関数内でパラメータの設定を行ってください。<br>関数の評価は実行SQL生成処理（SQL文内の/*IF*/や/*BEGIN*/、/*parameter_name*/の評価）の直前に行われます。</p>
<h2 id="SQLカバレッジ"><a href="#SQLカバレッジ" class="headerlink" title="SQLカバレッジ"></a>SQLカバレッジ</h2><p>これまでアプリケーション上の条件分岐はカバレッジツールを利用して網羅率を確認することができました。<br>しかし、SQL文の条件分岐は実際にその分岐が通っているかどうかを確認する手段がなく、リリース後に初めて通った条件で不具合を発生させることがありました。<br>この問題を解決するためにuroboroSQLでは、SQL文の条件分岐を集計してカバレッジレポートを行う機能を提供します。</p>
<p>SQLカバレッジはuroboroSQLを利用するアプリケーションの起動時オプションに<code>-Duroborosql.sql.coverage=true</code>を追加することで有効になります。<br>SQLカバレッジを有効にするとアプリケーションが実行している間に発行されるSQLについて、カバレッジ情報が収集されます。<br>カバレッジ情報の収集結果は標準では<code>target/coverage/sql-cover.xml</code>に出力されます。<br>このファイルの場所や名前を変更したい場合は、起動時オプションに<code>-Duroborosql.sql.coverage.file=[出力ファイルパス]</code>を指定してください。</p>
<p>出力された<code>sql-cover.xml</code>をJenkinsのCobertura pluginなどのXMLレポートとして読み込むとSQLファイルのカバレッジレポートが参照できるようになります。</p>
<p><img src="cobertura.png" alt="カバレッジレポート例" title="Jenkins Cobertura Report"></p>
<p>またv0.2.0より、uroboroSQLのみでHTMLレポートを出力することができるようになりました。<br>起動時オプションに<code>-Duroborosql.sql.coverage=jp.co.future.uroborosql.coverage.reports.html.HtmlReportCoverageHandler</code>を指定することで本機能を利用することができます。</p>
<p>カバレッジ情報はデフォルトでは<code>target/coverage/sql</code>フォルダ配下に出力されます。<br>出力先フォルダを変更した場合は、起動時オプションに<code>-Duroborosql.sql.coverage.dir=[出力フォルダパス]</code>を指定してください。</p>
<p>出力されたレポートのサンプルは下記を参照してください。</p>
<ul>
<li>サマリーページ<br><img src="html_coverage_report_summary.png" alt="HTML Coverage Report Summary" style="width:80%;"></li>
<li>詳細ページ<br><img src="html_coverage_report.png" alt="HTML Coverage Report" style="width:80%;"></li>
</ul>
<p><a href="../sample/testReport/" target="_blank" style="font-size:20px;"><i class="fa fa-external-link" aria-hidden="true"></i>出力サンプル</a></p>
<h2 id="ログ"><a href="#ログ" class="headerlink" title="ログ"></a>ログ</h2><p>uroboroSQLではログ出力ライブラリとしてSLF4Jを使用しています。SLF4Jの詳細は<a href="https://www.slf4j.org/" target="_blank" rel="noopener">公式のドキュメント</a>を参照して下さい。<br>uroboroSQLで出力されるログ内容は以下表の通りです。</p>
<table>
<thead>
<tr>
<th style="text-align:center">クラス名</th>
<th style="text-align:center">TRACE</th>
<th style="text-align:center">DEBUG</th>
<th style="text-align:center">INFO</th>
<th style="text-align:center">WARN</th>
<th style="text-align:center">ERROR</th>
<th style="text-align:center">FATAL</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">AbstractAgent</td>
<td style="text-align:center">変換前SQL</td>
<td style="text-align:center">実行時SQL</td>
<td style="text-align:center">-</td>
<td style="text-align:center">-</td>
<td style="text-align:center">-</td>
<td style="text-align:center">-</td>
</tr>
<tr>
<td style="text-align:center">DebugSqlFilter</td>
<td style="text-align:center">-</td>
<td style="text-align:center">パラメーター/<br>対象データ数/<br>実行結果</td>
<td style="text-align:center">-</td>
<td style="text-align:center">-</td>
<td style="text-align:center">-</td>
<td style="text-align:center">-</td>
</tr>
<tr>
<td style="text-align:center">IfNode</td>
<td style="text-align:center">-</td>
<td style="text-align:center">評価式/<br>判定結果/<br>パラメーター</td>
<td style="text-align:center">-</td>
<td style="text-align:center">-</td>
<td style="text-align:center">-</td>
<td style="text-align:center">-</td>
</tr>
<tr>
<td style="text-align:center">Parameter</td>
<td style="text-align:center">-</td>
<td style="text-align:center">パラメーターの設定</td>
<td style="text-align:center">-</td>
<td style="text-align:center">サブパラメーター値にNULLを設定</td>
<td style="text-align:center">-</td>
<td style="text-align:center">-</td>
</tr>
<tr>
<td style="text-align:center">SecretColumnSqlFilter</td>
<td style="text-align:center">-</td>
<td style="text-align:center">バッチ処理追加件数/<br>ストアドプロシージャ出力パラメーター</td>
<td style="text-align:center">-</td>
<td style="text-align:center">-</td>
<td style="text-align:center">-</td>
<td style="text-align:center">-</td>
</tr>
<tr>
<td style="text-align:center">SqlAgent</td>
<td style="text-align:center">ステートメントのクローズ</td>
<td style="text-align:center">処理実行アナウンス/<br>リトライ実行アナウンス/<br>SQL実行時間</td>
<td style="text-align:center">-</td>
<td style="text-align:center">-</td>
<td style="text-align:center">エラーメッセージ</td>
<td style="text-align:center">-</td>
</tr>
<tr>
<td style="text-align:center">SqlContext</td>
<td style="text-align:center">-</td>
<td style="text-align:center">バッチ処理追加件数/<br>ストアドプロシージャ出力パラメーター</td>
<td style="text-align:center">-</td>
<td style="text-align:center">-</td>
<td style="text-align:center">-</td>
<td style="text-align:center">-</td>
</tr>
<tr>
<td style="text-align:center">SqlContextFactory</td>
<td style="text-align:center">-</td>
<td style="text-align:center">定数パラメーター</td>
<td style="text-align:center">-</td>
<td style="text-align:center">定数名の重複</td>
<td style="text-align:center">エラーメッセージ</td>
<td style="text-align:center">-</td>
</tr>
<tr>
<td style="text-align:center">SqlLoader</td>
<td style="text-align:center">SQL定義ファイルの読み込み完了</td>
<td style="text-align:center">SQL定義ファイルの読み込み開始/読み込み中</td>
<td style="text-align:center">-</td>
<td style="text-align:center">-</td>
<td style="text-align:center">デフォルトファイルパスの設定/<br>デフォルト拡張子/<br>空のSQLキャッシュの返却</td>
<td style="text-align:center">-</td>
</tr>
</tbody>
</table>
<h2 id="システムプロパティ"><a href="#システムプロパティ" class="headerlink" title="システムプロパティ"></a>システムプロパティ</h2><p>uroboroSQLではシステムプロパティを指定することで動作を変更することができます。</p>
<table>
<thead>
<tr>
<th style="text-align:left">プロパティ名</th>
<th style="text-align:left">説明</th>
<th style="text-align:left">初期値</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">uroborosql.sql.coverage</td>
<td style="text-align:left">SQLカバレッジを出力するかどうかのフラグ。<code>true</code>の場合はSQLカバレッジを出力します。<br>文字列として<code>jp.co.future.uroborosql.coverage.CoverageHandler</code>インタフェースの<br>実装クラスが設定された場合はそのクラスを利用してカバレッジの収集を行います。</td>
<td style="text-align:left">なし</td>
</tr>
<tr>
<td style="text-align:left">uroborosql.sql.coverage.file</td>
<td style="text-align:left">指定されたPATH(ファイル)に SQLカバレッジのCobertura形式のxmlレポートを出力します。</td>
<td style="text-align:left">./target/coverage/sql-cover.xml</td>
</tr>
<tr>
<td style="text-align:left">uroborosql.sql.coverage.dir</td>
<td style="text-align:left">指定されたPATH(フォルダ)にSQLカバレッジのHTMLレポートを出力します。</td>
<td style="text-align:left">./target/coverage/sql</td>
</tr>
<tr>
<td style="text-align:left">uroborosql.entity.cache.size</td>
<td style="text-align:left">Entityクラス情報のキャッシュサイズを指定します。<br>キャッシュサイズを超えるEntityクラスの読み込みがあった場合は古い情報から破棄されます。</td>
<td style="text-align:left">30</td>
</tr>
</tbody>
</table>
<div style="font-size:130%; font-weight:bold;"><br><a href="../basics" style="float:left">&#60;&#60; 基本操作</a><a href="../developer_guide" style="float:right">開発者ガイド &#62;&#62;</a><br></div>


<!-- Tags -->



<div class="tags">
    
</div>



<!-- Comments -->
<div>
    


</div>



            </div>
        </div>

        <!-- Footer -->
<footer id="footer">
  <div class="inner">
      <div>
        <h2>Share</h2>
        <ul class="sns-area">
          <li>
            <a href="https://twitter.com/share" class="twitter-share-button" data-url="https://future-architect.github.io/uroborosql-doc/">Tweet</a>
            <script>
            ! function(d, s, id) {
              var js, fjs = d.getElementsByTagName(s)[0],
                p = /^http:/.test(d.location) ? 'http' : 'https';
              if (!d.getElementById(id)) { js = d.createElement(s);
                js.id = id;
                js.src = p + '://platform.twitter.com/widgets.js';
                fjs.parentNode.insertBefore(js, fjs); } }(document, 'script', 'twitter-wjs');

            </script>
          </li>
          <li>
            <iframe src="https://www.facebook.com/plugins/like.php?href=https%3A%2F%2Ffuture-architect.github.io%2Furoborosql-doc%2F&width=130&layout=button_count&action=like&size=small&show_faces=true&share=true&height=46&appId=316260158574612" width="130" height="46" style="border:none;overflow:hidden" scrolling="no" frameborder="0" allowtransparency="true"></iframe>
          </li>
          <li>
            <a href="http://b.hatena.ne.jp/entry/s/future-architect.github.io/uroborosql-doc/" class="hatena-bookmark-button" data-hatena-bookmark-layout="basic-counter" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;"></a>
            <script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
          </li>
          <li>
            <div class="g-plusone" data-size="medium" data-href="https://future-architect.github.io/uroborosql-doc/"></div>
          </li>
        </ul>
      </div>
      <div>
          <h2>Follow</h2>
          <ul class="icons">
              
                  <li><a href="https://twitter.com/future_techblog" class="icon style2 fa-twitter" target="_blank"><span class="label">Twitter</span></a></li>
              
              
                  <li><a href="https://www.facebook.com/future.saiyo" class="icon style2 fa-facebook" target="_blank"><span class="label">Facebook</span></a></li>
              
              
                  <li><a href="https://github.com/future-architect" class="icon style2 fa-github" target="_blank"><span class="label">GitHub</span></a></li>
              
              
                  <li><a href="http://qiita.com/organizations/future" class="icon style2 fa-pencil" target="_blank"><span class="label">Qiita</span></a></li>
              
              
                 <li><a href="https://future-architect.github.io/" class="icon style2 fa-pencil-square-o" target="_blank"><span class="label">Tech Blog</span></a></li>
              
          </ul>
      </div>
      <br>
      <ul class="copyright">
          <li>&copy; 2018 - 2019 Future Corporation. All rights reserved</li>
          <li>Design: <a href="http://html5up.net" target="_blank">HTML5 UP</a></li>
      </ul>
  </div>
</footer>
    </div>

    <!-- After footer scripts -->
    
<!-- jQuery -->
<script src="/uroborosql-doc/js/jquery.min.js"></script>

<!-- skel -->
<script src="/uroborosql-doc/js/skel.min.js"></script>

<!-- Custom Code -->
<script src="/uroborosql-doc/js/util.js"></script>

<!--[if lte IE 8]>
<script src="/uroborosql-doc/js/ie/respond.min.js"></script>
<![endif]-->

<!-- Custom Code -->
<script src="/uroborosql-doc/js/main.js"></script>

<!-- Gallery -->
<script src="//cdn.rawgit.com/noelboss/featherlight/1.3.5/release/featherlight.min.js" type="text/javascript" charset="utf-8"></script>

<!-- Disqus Comments -->


</body>

</html>